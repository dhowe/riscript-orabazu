"use strict";var z=Object.create;var O=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var B=(o,e,t)=>e in o?O(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var V=(o,e)=>{for(var t in e)O(o,t,{get:e[t],enumerable:!0})},x=(o,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of F(e))!q.call(o,i)&&i!==t&&O(o,i,{get:()=>e[i],enumerable:!(s=D(e,i))||s.enumerable});return o};var Q=(o,e,t)=>(t=o!=null?z(J(o)):{},x(e||!o||!o.__esModule?O(t,"default",{value:o,enumerable:!0}):t,o)),Z=o=>x(O({},"__esModule",{value:!0}),o);var C=(o,e,t)=>(B(o,typeof e!="symbol"?e+"":e,t),t);var ne={};V(ne,{RiGrammar:()=>y});module.exports=Z(ne);var v=Q(require("he"),1),U=require("mingo"),L=require("chevrotain");var u=require("chevrotain");function A(o){let e={OR:"|",ELSE:"||",DYNAMIC:"$",STATIC:"#",ENTITY:"&",OPEN_GATE:"@",CLOSE_GATE:"@",PENDING_GATE:"@@",OPEN_SILENT:"{",CLOSE_SILENT:"}"};Object.assign(e,o?{OPEN_CHOICE:"(",CLOSE_CHOICE:")",OPEN_WEIGHT:"[",CLOSE_WEIGHT:"]",CONTINUATION:"\\"}:{OPEN_CHOICE:"[",CLOSE_CHOICE:"]",OPEN_WEIGHT:"^",CLOSE_WEIGHT:"^",CONTINUATION:"~"});let i={};Object.entries(e).forEach(([H,Y])=>{i[H]=X(Y)});let r=new RegExp(`${i.PENDING_GATE}([0-9]{9,11})`);i.SPECIAL=Object.values(i).join("").replace(/[<>]/g,""),e.PENDING_GATE_RE=new RegExp(r.source,"g");let n=(0,u.createToken)({name:"ExitGate",pattern:new RegExp(`\\s*${i.CLOSE_GATE}`),pop_mode:!0}),a=(0,u.createToken)({name:"Gate",pattern:new RegExp(`[^${i.CLOSE_GATE}]+`)}),l=(0,u.createToken)({name:"PendingGate",pattern:r}),c=(0,u.createToken)({name:"EnterGate",pattern:new RegExp(`${i.OPEN_GATE}\\s*`),push_mode:"gate_mode"}),f=(0,u.createToken)({name:"OC",pattern:new RegExp(i.OPEN_CHOICE+"\\s*")}),g=(0,u.createToken)({name:"CC",pattern:new RegExp(`\\s*${i.CLOSE_CHOICE}`)}),p=(0,u.createToken)({name:"OR",pattern:/\s*\|\s*/}),m=(0,u.createToken)({name:"ELSE",pattern:/\s*\|\|\s*/}),T=(0,u.createToken)({name:"EQ",pattern:/\s*=\s*/}),_=(0,u.createToken)({name:"TF",pattern:/\.[A-Za-z_0-9][A-Za-z_0-9]*(\(\))?/}),P=(0,u.createToken)({name:"OS",pattern:new RegExp(`${i.OPEN_SILENT}\\s*`)}),M=(0,u.createToken)({name:"CS",pattern:new RegExp(`\\s*${i.CLOSE_SILENT}`)}),G=(0,u.createToken)({name:"SYM",pattern:new RegExp(`[${i.DYNAMIC}${i.STATIC}][A-Za-z_0-9]*`)}),k=(0,u.createToken)({name:"Entity",pattern:/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-fA-F]{1,6});/i}),W=(0,u.createToken)({name:"Weight",pattern:new RegExp(`\\s*${i.OPEN_WEIGHT}.+${i.CLOSE_WEIGHT}\\s*`)}),j=(0,u.createToken)({name:"Raw",pattern:new RegExp(`[^${i.SPECIAL}]+`)});return{tokens:{modes:{normal:[k,W,m,f,g,p,T,G,_,P,M,l,j,c],gate_mode:[a,n]},defaultMode:"normal"},Constants:{Symbols:e,Escaped:i}}}function X(o){return o.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}var $=require("chevrotain"),R=class extends $.CstParser{constructor(e){super(e,{nodeLocationTracking:"full"}),this.atomTypes=["silent","assign","symbol","choice","pgate","text","entity"],this.buildRules()}parse(e){this.input=e.tokens;let t=this.script();if(this.errors.length>0)throw Error(`[PARSING]
`+this.errors[0].message);return t}buildRules(){let e=this,t=this.tokensMap;e.RULE("script",()=>{e.MANY(()=>e.SUBRULE(e.expr))}),e.RULE("pgate",()=>{e.CONSUME(t.PendingGate),e.MANY(()=>e.CONSUME(t.TF))}),e.RULE("entity",()=>{e.CONSUME(t.Entity)}),e.RULE("gate",()=>{e.CONSUME(t.EnterGate),e.MANY(()=>e.CONSUME(t.Gate)),e.CONSUME(t.ExitGate)}),e.RULE("silent",()=>{e.CONSUME(t.OS),e.OPTION1(()=>e.SUBRULE(e.gate)),e.CONSUME(t.SYM),e.OPTION2(()=>{e.CONSUME(t.EQ),e.SUBRULE(e.expr)}),e.CONSUME(t.CS)}),e.RULE("assign",()=>{e.CONSUME(t.SYM),e.CONSUME(t.EQ),e.SUBRULE(e.expr)}),e.RULE("symbol",()=>{e.CONSUME(t.SYM),e.MANY(()=>e.CONSUME(t.TF))}),e.RULE("accept",()=>{e.SUBRULE(e.or_expr)}),e.RULE("reject",()=>{e.SUBRULE(e.or_expr)}),e.RULE("or_expr",()=>{e.MANY_SEP({SEP:t.OR,DEF:()=>e.SUBRULE(e.wexpr)})}),e.RULE("choice",()=>{e.CONSUME(t.OC),e.OPTION1(()=>e.SUBRULE(e.gate)),e.SUBRULE(e.accept),e.OPTION2(()=>{e.CONSUME(t.ELSE),e.SUBRULE(e.reject)}),e.CONSUME(t.CC),e.MANY(()=>e.CONSUME(t.TF))}),e.RULE("wexpr",()=>{e.MANY(()=>{e.OR([{ALT:()=>e.SUBRULE(e.expr)},{ALT:()=>e.CONSUME(t.Weight)}])})}),e.RULE("expr",()=>{e.AT_LEAST_ONE(()=>e.SUBRULE(e.atom))}),e.RULE("atom",()=>{e.OR(this.atomTypes.map(s=>({ALT:()=>e.SUBRULE(e[s])})))}),e.RULE("text",()=>{e.CONSUME(t.Raw)}),this.performSelfAnalysis()}};var I=class{constructor(e){this.input=0,this.path="",this.tracePath=!0,this.scripting=e,this.warnOnInvalidGates=!1,this.RiScript=this.scripting.constructor}isCstNode(e){return typeof e=="object"&&("accept"in e||"name"in e&&"location"in e&&"children"in e)}visit(e,t){if(Array.isArray(e)&&(e=e[0]),typeof e>"u")return;if(!this.isCstNode(e))throw Error("Non-cstNode passed to visit: "+JSON.stringify(e));let{name:s,location:i}=e;if(this.nodeText=this.input.substring(i.startOffset,i.endOffset+1),typeof this[s]!="function")throw Error(`BaseVisitor.visit: expecting function for this[${s}], found ${typeof this[s]}: ${JSON.stringify(this[s])}`);return this.tracePath&&!/(expr|atom|silent)/.test(s)&&(this.path+=s+"."),this[s](e.children,t)}validateVisitor(){}},N=class extends I{constructor(e,t={}){super(e),this.context=t,this.trace=0,this.choices={},this.isNoRepeat=!1,this.symbols=this.scripting.Symbols,this.escaped=this.scripting.Escaped,this.statics={},this.dynamics={},this.pendingGates={},this.pendingSymbols=new Set,this.validateVisitor()}start(e={}){if(this.input=e.input,this.trace=e.trace,this.traceTx=e.traceTx,!e.cst)throw Error("no cst");return super.visit(e.cst)}script(e){this.order=0;let t=e.expr?e.expr.length:0;if(this.print("script","'"+this.RiScript._escapeText(this.input)+"' :: "+t+" expression(s)"),!t)return"";if(Object.keys(e).length!==1)throw Error("script: invalid expr");return this.visit(e.expr)}expr(e){let t=Object.keys(e);if(t.length!==1)throw Error("invalid expr: "+t.length);let s=e.atom.map(i=>this.visit(i));for(let i=1;i<s.length-1;i++)s[i].length===0&&s[i-1].endsWith(" ")&&s[i+1].startsWith(" ")&&(s[i+1]=s[i+1].substring(1));return s.join("")}wexpr(e){this.print("wexpr")}gate(e){if(e.Gate.length!==1)throw Error("Invalid gate: "+e.Gate);let t,s=e.Gate[0].image;try{t=this.scripting._query(s)}catch(l){if(!this.warnOnInvalidGates)throw Error(`Invalid gate[2]: "@${s}@"

RootCause -> ${l}`);return!this.scripting.RiTa.SILENT&&!this.scripting.silent&&console.warn(`[WARN] Ignoring invalid gate: @${s}@
`,l),{decision:"accept"}}let i={},r=[],n=t.operands();if(n.forEach(l=>{let{result:c,resolved:f,isStatic:g,isUser:p}=this.checkContext(l);typeof c=="function"&&(c=c.call(),f=!this.scripting.isParseable(c)),typeof c>"u"||!f?r.push(l):(g?this.statics[l]=c:p?this.context[l]=c:this.dynamics[l]=c,i[l]=c)}),Object.keys(i).length+r.length!==n.length)throw Error("invalid operands");if(r.length)return{decision:"defer",operands:r};let a=t.test(i);return!a&&this.castValues(i)&&(a=t.test(i)),{decision:a?"accept":"reject"}}assign(e,t){let s=e.SYM[0].image,i,r,n=s.replace(this.scripting.AnySymbolRE,"");if(s.startsWith(this.symbols.STATIC))i=this.visit(e.expr),this.scripting.isParseable(i)?(this.statics[n]=i,i=this.inlineAssignment(n,e.TF,i)):(this.statics[n]=i,this.pendingSymbols.delete(n),this.trace&&console.log("  [pending.delete]",s,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):"")),r=`${s} = ${this.RiScript._escapeText(i)} [#static] ${t?.silent?"{silent}":""}`;else{let l=this;i=()=>l.visit(e.expr),r=`${s} = <f*:pending>`+(t?.silent?"{silent}":""),this.dynamics[n]=i}return this.print("assign",r),i}silent(e){return e.EQ?this.assign(e,{silent:!0}):this.symbol(e,{silent:!0}),""}atom(e){let t,s=Object.keys(e);if(s.length!==1)throw Error("invalid atom: "+s);return this.scripting.parser.atomTypes.forEach(i=>{let r=e[i];if(r){if(r.length!==1)throw Error(i+": bad length -> "+e[i].length);t=this.visit(r[0])}}),typeof t=="function"&&(t=t.call()),t}text(e){if(e.Raw.length!==1)throw Error("[1] invalid text");if(Object.keys(e).length!==1)throw Error("[2] invalid text");let t=e.Raw[0].image;return this.print("text",this.RiScript._escapeText("'"+t+"'")),t}entity(e){return this.nodeText}symbol(e,t){if(e.SYM.length!==1)throw Error("[1] invalid symbol");let s=this.nodeText,i=e.SYM[0].image,r=i.replace(this.scripting.AnySymbolRE,"");if(this.isNoRepeat=this.hasNoRepeat(e.TF),this.pendingSymbols.has(r))return this.print("symbol",`${i} [is-pending]`),s;let{result:n,isStatic:a,isUser:l,resolved:c}=this.checkContext(r);if(!a&&i.startsWith(this.symbols.STATIC)&&!this.scripting.EntityRE.test(i))throw Error(`Attempt to refer to dynamic symbol '${r}' as ${this.symbols.STATIC}${r}, did you mean $${r}?`);if(typeof n=="function"&&(n=n.call(),c=!this.scripting.isParseable(n)),this.isNoRepeat&&(a||l)){this.isNoRepeat=!1;let g="Attempt to call norepeat() on "+(a?"static symbol '"+i+"'. Did you mean to use '"+this.symbols.DYNAMIC+r+"' ?":"non-dynamic symbol '"+r+"'. Did you mean to define '"+this.symbols.DYNAMIC+r+"' in riscript?");throw Error(g)}if(typeof n>"u")return this.print("symbol",i+" -> '"+s+"' ctx="+this.lookupsToString(),"[deferred]",t?.silent?"{silent}":""),s;let f=s+" -> '"+n+"'"+(t?.silent?" {silent}":"");return typeof n=="string"&&!c?(a?(this.pendingSymbols.add(r),n=this.inlineAssignment(r,e.TF,n),this.print("symbol*",`${s} -> ${n} :: pending.add(${r})`)):(e.TF&&(n=this.restoreTransforms(n,e.TF)),this.print("symbol",f)),n):(a&&(this.statics[r]=n),e.TF&&(n=this.applyTransforms(n,e.TF),f+=" -> '"+n+"'",this.isNoRepeat&&(f+=" (norepeat)")),this.print("symbol",f),this.pendingSymbols.has(r)&&(this.trace&&console.log("  [$pending.delete]",(a?"#":"$")+r,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):""),this.pendingSymbols.delete(r)),this.isNoRepeat=!1,n)}pgate(e){this.print("pgate",this.nodeText);let t=this.nodeText,s=t.replace(this.symbols.PENDING_GATE,""),i=this.pendingGates[s];if(!i)throw Error('no pending gate="'+t+'" pgates='+JSON.stringify(Object.keys(this.pendingGates)));return i.operands.some(a=>{let{result:l,resolved:c}=this.checkContext(a);return typeof l=="function"&&(l=l.call(),c=!this.scripting.isParseable(l)),typeof l>"u"||!c})?t:this.choice(i.deferredContext)}else(e){return this.visit(e.expr).trim()}choice(e,t){let s=this.symbols,i,r,n=this.nodeText,a=n,l=this.RiScript._stringHash(n+" #"+this.choiceId(e));if(!this.isNoRepeat&&this.hasNoRepeat(e.TF))throw Error("noRepeat() not allowed on choice (use a $variable instead): "+n);let c="accept";if(t?.forceReject)c="reject";else if(e.gate&&(i=e.gate[0].children.Gate[0].image,r=this.visit(e.gate),c=r.decision,a+=`
  [gate] ${i} -> ${c!=="defer"?c.toUpperCase():`DEFER ${s.PENDING_GATE}${l}`}  ${this.lookupsToString()}`),r&&r.decision==="defer")return this.pendingGates[l]={deferredContext:e,operands:r.operands},`${s.PENDING_GATE}${l}`;if(c==="reject"&&!("reject"in e))return"";let f=e[c]?.[0]?.children?.or_expr?.[0],g=this.parseOptions(f);if(!g)throw Error("No options in choice: "+n);let p=null,m=[],T=!1;for(;p===null;){if(p=this.choose(g,m).value,this.scripting.isParseable(p)){e.TF&&(p=this.restoreTransforms(p,e.TF)),T=!0;break}if(e.TF&&(p=this.applyTransforms(p,e.TF)),this.isNoRepeat&&p===this.choices[l]){this.print("choice.reject",p+" [norepeat]"),m.push(p),p=null;continue}}return T||(this.choices[l]=p),p}hasNoRepeat(e){let t=this.RiScript._transformNames(e);return t.length?t.includes("nr")||t.includes("norepeat"):!1}checkContext(e){let t=!1,s=!1,i;if(e.length===0)return{result:"",resolved:!0,isStatic:t,isUser:s};i=this.dynamics[e],typeof i>"u"&&(i=this.statics[e],typeof i<"u"&&(t=!0)),typeof i>"u"&&(i=this.context[e],typeof i<"u"?s=!0:i=this.context[this.symbols.DYNAMIC+e]);let r=!this.scripting.isParseable(i);return{result:i,isStatic:t,isUser:s,resolved:r}}inlineAssignment(e,t,s){let i=this.symbols,r=i.STATIC+e,n=this.restoreTransforms(s,t);return s=i.OPEN_CHOICE+(r+"="+n)+i.CLOSE_CHOICE,s}choiceId(e){if(!e.OC||!e.OC.length)throw Error("invalid choice");return e.OC[0].startOffset+"."+e.OC[0].endOffset}parseOptions(e){let t=[];if(e&&e?.children?.wexpr){let s=e.children.wexpr;for(let i=0;i<s.length;i++){let r=s[i],n=r.children.expr;if(n&&n.length!=1)throw Error("invalid choice-expr: "+n.length);let a=r.children.Weight;if(a){if(a.length!=1)throw Error("invalid weight: "+a.length);let l=1;try{l=parseInt(this.symbols.CLOSE_WEIGHT.length?a[0].image.trim().slice(1,-1):a[0].image.trim().slice(1))}catch{console.log("EX: "+l)}Array.from({length:l},()=>t.push(n))}else t.push(n||"")}}return t}chooseUnique(e,t){for(;e.length;){let{index:i,value:r}=this.choose(e);if(r!==this.choices[t])return r;e.splice(i,1)}throw Error("No remaining options")}choose(e,t=[]){if(!e||!e.length)throw Error("Invalid choice: no options");let s=e.filter(a=>!t.includes(a));if(!s.length)throw Error("Invalid choice: no valid options");let i=this.scripting.RiTa.randi(s.length),r="",n=s[i];return typeof n=="string"?this.print("choice.text","''"):(this.path="choice."+this.path,r=this.visit(n)),typeof r=="string"&&(r=r.trim()),{index:i,value:r}}applyTransforms(e,t){this.traceTx&&console.log("applyTransforms",this.formatTxs(...arguments));for(let s=0;s<t.length;s++)e=this.applyTransform(e,t[s]);return e}restoreTransforms(e,t){return typeof e=="string"&&(new RegExp("^"+this.escaped.OPEN_CHOICE+".*"+this.escaped.CLOSE_CHOICE+"$").test(e)||(e=this.symbols.OPEN_CHOICE+e+this.symbols.CLOSE_CHOICE),t&&t.forEach(i=>e+=i.image),this.traceTx&&console.log("restoreTransforms:",e)),e}castValues(e){let t=!1;return Object.entries(e).forEach(([s,i])=>{let r=parseFloat(i);isNaN(r)||(t=!0,e[s]=r)}),t}contextIsResolved(e){let t=!0;return Object.entries(e).forEach(([s,i])=>{this.scripting.isParseable(i)||(t=!1)}),t}applyTransform(e,t){let s=t.image,i,r=e+s,n=s.substring(1).replace(/\(\)$/,"");return typeof this.dynamics[n]=="function"?i=this.dynamics[n](e):typeof this.statics[n]=="function"?i=this.statics[n](e):typeof this.context[n]=="function"?i=this.context[n](e):typeof this.RiScript.transforms[n]=="function"?i=this.RiScript.transforms[n](e):typeof e[n]=="function"?i=e[n]():e.hasOwnProperty(n)?i=e[n]:(!this.scripting.RiTa.SILENT&&!this.scripting.silent&&console.warn("[WARN] Unresolved transform: "+r),i=r.replace(/\(\)$/,"&lpar;&rpar;")),this.trace&&console.log(`${this.tindent()}[transform] ${r} -> '${i}'`),i}lookupsToString(){let e={},t={};return Object.entries(this.dynamics||{}).forEach(([s,i])=>e[`$${s} `]=i),Object.entries(this.statics||{}).forEach(([s,i])=>t[`#${s} `]=i),JSON.stringify({...this.context,...t,...e},(s,i)=>typeof i=="function"?"<f*:pending>":i).replace(/"/g,"")}formatTxs(e,t){return e+t.map(s=>s.image.replace(/()/,"")+"()").join("")}print(e,...t){this.trace&&(this.path&&e!=="script"&&(e=this.path.replace(/\.$/,"")),console.log(++this.order,`[${e}]`,...t),this.path="")}tindent(){return" ".repeat((this.order+"").length+1)}};var{decode:K}=v.default,ee=/[aeiou]/,S="_RE_",te=/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-fA-F]{1,6});/gi,w=class extends U.Query{constructor(e,t,s){if(typeof t=="string"){let i=t;t=e.parseJSOL(t)}super(t,s)}test(e){for(let t=0,s=this.compiled.length;t<s;t++)if(!this.compiled[t](e))return!1;return!0}operands(){let e=[this.condition],t=new Set;for(;e?.length>0;){let s=e.pop();Object.keys(s).forEach(i=>{let r=s[i];i.startsWith("$")||t.add(i),typeof r=="object"&&r!==null&&(Array.isArray(r)?r:[r]).forEach(a=>e.push(a))})}return Array.from(t)}},E=class{static evaluate(e,t,s={}){return new E().evaluate(e,t,s)}constructor(e={}){this.visitor=0,this.v2Compatible=e.compatibility===2;let{Constants:t,tokens:s}=A(this.v2Compatible);this.Escaped=t.Escaped,this.Symbols=t.Symbols;let i=t.Escaped.STATIC+t.Escaped.DYNAMIC,r=t.Escaped.OPEN_CHOICE,n=t.Escaped.CLOSE_CHOICE;this.JSOLIdentRE=new RegExp(`([${i}]?[A-Za-z_0-9][A-Za-z_0-9]*)\\s*:`,"g"),this.RawAssignRE=new RegExp(`^[${i}][A-Za-z_0-9][A-Za-z_0-9]*\\s*=`),this.ChoiceWrapRE=new RegExp("^"+r+"[^"+r+n+"]*"+n+"$"),this.SpecialRE=new RegExp(`[${this.Escaped.SPECIAL.replace("&","")}]`),this.ContinueRE=new RegExp(this.Escaped.CONTINUATION+"\\r?\\n","g"),this.WhitespaceRE=/[\u00a0\u2000-\u200b\u2028-\u2029\u3000]+/g,this.AnySymbolRE=new RegExp(`[${i}]`),this.silent=!1,this.lexer=new L.Lexer(s),this.parser=new R(s),this.RiTa=e.RiTa||{VERSION:0,randi:a=>Math.floor(Math.random()*a)}}lex(e){if(!e.input)throw Error("no input");let t=this.lexer.tokenize(e.input);if(t.errors.length)throw console.error("Input: "+e.input+`
`,t.errors[0].message),Error("[LEXING] "+t.errors[0].message);e.trace&&this.printTokens(t.tokens),e.tokens=t.tokens}parse(e){e.cst=this.parser.parse(e)}visit(e){return this.visitor.start(e)}lexParseVisit(e={}){return this.lex(e),this.parse(e),this.visit(e)}evaluate(e,t,s={}){if(typeof e!="string")throw Error("RiScript.evaluate() expects a string, got "+typeof e);return s.input=e,s.visitor=new N(this,t),this._evaluate(s)}_evaluate(e){let{input:t}=e,s,i=/\r?\n$/.test(t),r=this.preParse(t,e);if(!r)return"";if(e.trace&&console.log(`
Input:  '${E._escapeText(t)}'`),e.trace&&t!==r&&console.log(`Parsed: '${E._escapeText(r)}'`),!e.visitor)throw Error("no visitor");this.visitor=e.visitor,delete e.visitor;for(let n=1;r!==s&&n<=10&&(s=r,e.trace&&console.log("-".repeat(20)+" Pass#"+n+" "+"-".repeat(20)),e.input=r,r=this.lexParseVisit(e),e.trace&&console.log(`Result(${n}) -> "${E._escapeText(r)}" ctx=${this.visitor.lookupsToString()}`),!(e.onepass||!this.isParseable(r)));n++);return!this.silent&&!this.RiTa.SILENT&&this.AnySymbolRE.test(r.replace(te,""))&&console.warn('[WARN] Unresolved symbol(s) in "'+r.replace(/\n/g,"\\n")+'" '),this.postParse(r,e)+(i?`
`:"")}_query(e,t){return new w(this,e,t)}printTokens(e){let t=e.reduce((s,i)=>{let{name:r}=i.tokenType,n=r;return n==="TEXT"&&(n=E._escapeText(i.image,1)),n==="SYM"&&(n="sym("+i.image+")"),n==="TX"&&(n="tx("+i.image+")"),s+n+", "},"").slice(0,-2);console.log(`
Tokens: [ `+t+" ]  Context:",this.visitor.lookupsToString())}postParse(e,t){if(typeof e!="string")return"";let i=K(e).replace(this.WhitespaceRE," ").replace(/\r?\n$/,"");return[...i.matchAll(this.Symbols.PENDING_GATE_RE)].forEach(n=>{if(!n||!n[0]||!n[1])throw Error("bad gate: "+n);let a=this.visitor.pendingGates[n[1]],{deferredContext:l,operands:c}=a;if(!c.length)throw Error("no operands");let f=this.visitor.choice(l,{forceReject:!0});i=i.replace(n[0],f),t.trace&&console.log("  "+n[0]+"-> "+f)}),t.trace&&console.log(`
Final: '${i}'`),t.preserveLookups||(this.visitor.statics=void 0,this.visitor.dynamics=void 0),i}preParse(e,t){if(typeof e!="string")return"";let s=this.Symbols,i=e;this.v2Compatible||(i=i.replace(/\((\s*\d+\s*)\)/g,"^$1^")),i=i.replace(/\/\*[^]*?(\r?\n)?\//g,""),i=i.replace(/\/\/[^\n]+(\r?\n|$)/g,""),i=i.replace(this.ContinueRE,""),i=ie(i);let r="",n=i.split(/\r?\n/);for(let a=0;a<n.length;a++)if(this.RawAssignRE.test(n[a])){let l=n[a].indexOf("=");if(l<0)throw Error("invalid state: no assigment: "+n[a]);let c=n[a].substring(0,l),f=n[a].substring(l+1),g=b(f,s.OPEN_CHOICE),p=b(f,s.CLOSE_CHOICE);for(;g>p;){let m=n[++a];f+=`
`+m,g+=b(m,s.OPEN_CHOICE),p+=b(m,s.CLOSE_CHOICE)}r+=s.OPEN_SILENT+(c+"="+f)+s.CLOSE_SILENT}else r+=n[a],a<n.length-1&&(r+=`
`);return r}parseJSOL(e){let t=n=>{let a=n;if(typeof n=="string"&&n.startsWith(S)&&n.endsWith(S)){let l=n.split(S);if(l.length!==4)throw Error("invalid regex in unescape");a=new RegExp(l[1],l[2])}return a},s=E._escapeJSONRegex(e).replace(this.JSOLIdentRE,'"$1":').replace(/'/g,'"'),i=JSON.parse(s),r=t;return Object.keys(i).forEach(n=>i[n]=r(i[n])),i}isParseable(e){let t=!0;return/(string|number)/.test(typeof e)&&(t=this.SpecialRE.test(e.toString())),t}static articlize(e){if(!e||!e.length)return"";let t=e.split(/\s+/)[0];if(!E.RiTa?.phones)return E.RiTaWarnings.phones||(console.warn("[WARN] Install RiTa for proper phonemes"),E.RiTaWarnings.phones=!0),(/^[aeiou].*/i.test(t)?"an ":"a ")+e;let s=E.RiTa.phones(t,{silent:!0});return(s&&s.length&&ee.test(s[0])?"an ":"a ")+e}static capitalize(e){return e?e[0].toUpperCase()+e.substring(1):""}static uppercase(e){return e?e.toUpperCase():""}static quotify(e){return"&#8220;"+(e||"")+"&#8221;"}static pluralize(e){return E.RiTa?.pluralize?E.RiTa.pluralize(e):(E.RiTaWarnings.plurals||(E.RiTaWarnings.plurals=!0,console.warn("[WARN] Install RiTa for proper pluralization")),e.endsWith("s")?e:e+"s")}static identity(e){return e}static _transformNames(e){return e&&e.length?e.map(t=>t.image.replace(/(^\.|\(\)$)/g,""),[]):[]}static _escapeText(e,t){if(typeof e!="string")return e;let s=e.replace(/\r?\n/g,"\\n");return t||!s.length?"'"+s+"'":s}static _escapeJSONRegex(e){return e.replace(/\/([^/]+?)\/([igmsuy]*)/g,`"${S}$1${S}$2${S}"`)}static _stringHash(e){let t,s=0;for(let r=0;r<e.length;r++)t=e.charCodeAt(r),s=(s<<5)-s+t,s|=0;let i=s.toString();return s<0?i.replace("-","0"):i}},h=E;C(h,"Query",w),C(h,"VERSION","[VI]{version}[/VI]"),C(h,"RiTaWarnings",{plurals:!1,phones:!1});h.transforms={quotify:h.quotify,pluralize:h.pluralize,capitalize:h.capitalize,articlize:h.articlize,uppercase:h.uppercase,norepeat:h.identity,art:h.articlize,nr:h.identity,cap:h.capitalize,ucf:h.capitalize,uc:h.uppercase,qq:h.quotify,s:h.pluralize};function ie(o){return o=d(o,"\\(","&lpar;"),o=d(o,"\\)","&rpar;"),o=d(o,"\\[","&lsqb;"),o=d(o,"\\]","&rsqb;"),o=d(o,"\\{","&lcqb;"),o=d(o,"\\}","&rcqb;"),o=d(o,"\\@","&commat;"),o=d(o,"\\#","&num;"),o=d(o,"\\|"," &vert"),o=d(o,"\\="," &equals"),o}function se(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function d(o,e,t){return o.replace(new RegExp(se(e),"g"),()=>t)}function b(o,e){let t=0;for(let s=0;s<o.length;s++)o[s]===e&&t++;return t}var y=class{constructor(e={},t={}){if(typeof e!="object")throw Error("RiGrammar: expecting object, found "+typeof e);this.scripting=new h,this.context=t,this.setRules(e)}static expand(e,t,s){return new y(e,t).expand(s)}addTransform(){return h.addTransform(...arguments)}removeTransform(){return h.removeTransform(...arguments)}getTransforms(){return h.transforms}equals(e){return e.toJSON()===this.toJSON()}expand(e={}){if("context"in e)throw Error("pass context to RiScript.grammar() or new RiGrammar() instead");return e.visitor=e.visitor||new h.Visitor(this.scripting),e.visitor.context=this.context||{},e.input=this._toScript(e),this.scripting._evaluate(e)}addRule(e,t){this._validateRule(e,t),this.rules[e]=t}setRules(e){if(typeof e>"u")throw Error("undefined rules");this.rules={};let t=typeof e=="string"?re(e):e,s=this;Object.entries(t).forEach(i=>s.addRule(...i))}removeRule(e){e in this.rules&&delete this.rules[e]}toJSON(){return JSON.stringify(this.rules,...arguments)}toString(e={}){let t=e.replacer||0,s=e.space||2,i=e?.linebreak,r=this.toJSON(t,s);return i&&(r=r.replace(/\n/g,i)),r}static fromJSON(e,t){return new y(JSON.parse(e),t)}_toScript(e){let t="",s=e.start||"start",{Symbols:i}=this.scripting;if(s.startsWith(i.DYNAMIC)&&(s=s.substring(i.DYNAMIC.length)),s.startsWith(i.STATIC)&&(s=s.substring(i.STATIC.length)),!(s in this.rules||i.STATIC+s in this.rules))throw Error('Rule: "'+s+'" not found in grammar');return Object.entries(this.rules).forEach(([r,n],a)=>{for(;r.startsWith(i.DYNAMIC);)r=r.substring(1);r.startsWith(i.STATIC)||(r=i.DYNAMIC+r),this.scripting.ChoiceWrapRE.test(n)||(n=i.OPEN_CHOICE+n+i.CLOSE_CHOICE),t+=`${r}=${n}
`}),e.trace&&console.log(`Grammar:
`+t.replace(/^\$/gm,"  $")),t+=`${i.DYNAMIC}${s}`,t}_validateRule(e,t){if(typeof e!="string"||e.length===0)throw Error("expected [string] name");if(typeof t>"u")throw Error("undefined rule def: "+e);let{Symbols:s}=this.scripting;if(e.startsWith(s.DYNAMIC))throw e=e.substring(s.DYNAMIC.length),Error("Grammar rules are dynamic by default; if you need a static rule, use '"+s.STATIC+e+"', otherwise just use '"+e+"'.")}};function re(o){if(typeof o=="string")try{return JSON.parse(o)}catch{throw Error(`RiGrammar appears to be invalid JSON, please check it at http://jsonlint.com/
`+o)}}0&&(module.exports={RiGrammar});
