var M=Object.defineProperty;var k=(o,t,e)=>t in o?M(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var R=(o,t,e)=>(k(o,typeof t!="symbol"?t+"":t,e),e);import H from"he";import{Query as Y}from"mingo";import{Lexer as z}from"chevrotain";import{createToken as u}from"chevrotain";function I(o){let t={OR:"|",ELSE:"||",DYNAMIC:"$",STATIC:"#",ENTITY:"&",OPEN_GATE:"@",CLOSE_GATE:"@",PENDING_GATE:"@@",OPEN_SILENT:"{",CLOSE_SILENT:"}"};Object.assign(t,o?{OPEN_CHOICE:"(",CLOSE_CHOICE:")",OPEN_WEIGHT:"[",CLOSE_WEIGHT:"]",CONTINUATION:"\\"}:{OPEN_CHOICE:"[",CLOSE_CHOICE:"]",OPEN_WEIGHT:"^",CLOSE_WEIGHT:"^",CONTINUATION:"~"});let i={};Object.entries(t).forEach(([P,G])=>{i[P]=W(G)});let r=new RegExp(`${i.PENDING_GATE}([0-9]{9,11})`);i.SPECIAL=Object.values(i).join("").replace(/[<>]/g,""),t.PENDING_GATE_RE=new RegExp(r.source,"g");let n=u({name:"ExitGate",pattern:new RegExp(`\\s*${i.CLOSE_GATE}`),pop_mode:!0}),a=u({name:"Gate",pattern:new RegExp(`[^${i.CLOSE_GATE}]+`)}),l=u({name:"PendingGate",pattern:r}),c=u({name:"EnterGate",pattern:new RegExp(`${i.OPEN_GATE}\\s*`),push_mode:"gate_mode"}),f=u({name:"OC",pattern:new RegExp(i.OPEN_CHOICE+"\\s*")}),g=u({name:"CC",pattern:new RegExp(`\\s*${i.CLOSE_CHOICE}`)}),p=u({name:"OR",pattern:/\s*\|\s*/}),m=u({name:"ELSE",pattern:/\s*\|\|\s*/}),T=u({name:"EQ",pattern:/\s*=\s*/}),x=u({name:"TF",pattern:/\.[A-Za-z_0-9][A-Za-z_0-9]*(\(\))?/}),A=u({name:"OS",pattern:new RegExp(`${i.OPEN_SILENT}\\s*`)}),$=u({name:"CS",pattern:new RegExp(`\\s*${i.CLOSE_SILENT}`)}),v=u({name:"SYM",pattern:new RegExp(`[${i.DYNAMIC}${i.STATIC}][A-Za-z_0-9]*`)}),U=u({name:"Entity",pattern:/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-fA-F]{1,6});/i}),L=u({name:"Weight",pattern:new RegExp(`\\s*${i.OPEN_WEIGHT}.+${i.CLOSE_WEIGHT}\\s*`)}),_=u({name:"Raw",pattern:new RegExp(`[^${i.SPECIAL}]+`)});return{tokens:{modes:{normal:[U,L,m,f,g,p,T,v,x,A,$,l,_,c],gate_mode:[a,n]},defaultMode:"normal"},Constants:{Symbols:t,Escaped:i}}}function W(o){return o.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}import{CstParser as j}from"chevrotain";var C=class extends j{constructor(t){super(t,{nodeLocationTracking:"full"}),this.atomTypes=["silent","assign","symbol","choice","pgate","text","entity"],this.buildRules()}parse(t){this.input=t.tokens;let e=this.script();if(this.errors.length>0)throw Error(`[PARSING]
`+this.errors[0].message);return e}buildRules(){let t=this,e=this.tokensMap;t.RULE("script",()=>{t.MANY(()=>t.SUBRULE(t.expr))}),t.RULE("pgate",()=>{t.CONSUME(e.PendingGate),t.MANY(()=>t.CONSUME(e.TF))}),t.RULE("entity",()=>{t.CONSUME(e.Entity)}),t.RULE("gate",()=>{t.CONSUME(e.EnterGate),t.MANY(()=>t.CONSUME(e.Gate)),t.CONSUME(e.ExitGate)}),t.RULE("silent",()=>{t.CONSUME(e.OS),t.OPTION1(()=>t.SUBRULE(t.gate)),t.CONSUME(e.SYM),t.OPTION2(()=>{t.CONSUME(e.EQ),t.SUBRULE(t.expr)}),t.CONSUME(e.CS)}),t.RULE("assign",()=>{t.CONSUME(e.SYM),t.CONSUME(e.EQ),t.SUBRULE(t.expr)}),t.RULE("symbol",()=>{t.CONSUME(e.SYM),t.MANY(()=>t.CONSUME(e.TF))}),t.RULE("accept",()=>{t.SUBRULE(t.or_expr)}),t.RULE("reject",()=>{t.SUBRULE(t.or_expr)}),t.RULE("or_expr",()=>{t.MANY_SEP({SEP:e.OR,DEF:()=>t.SUBRULE(t.wexpr)})}),t.RULE("choice",()=>{t.CONSUME(e.OC),t.OPTION1(()=>t.SUBRULE(t.gate)),t.SUBRULE(t.accept),t.OPTION2(()=>{t.CONSUME(e.ELSE),t.SUBRULE(t.reject)}),t.CONSUME(e.CC),t.MANY(()=>t.CONSUME(e.TF))}),t.RULE("wexpr",()=>{t.MANY(()=>{t.OR([{ALT:()=>t.SUBRULE(t.expr)},{ALT:()=>t.CONSUME(e.Weight)}])})}),t.RULE("expr",()=>{t.AT_LEAST_ONE(()=>t.SUBRULE(t.atom))}),t.RULE("atom",()=>{t.OR(this.atomTypes.map(s=>({ALT:()=>t.SUBRULE(t[s])})))}),t.RULE("text",()=>{t.CONSUME(e.Raw)}),this.performSelfAnalysis()}};var w=class{constructor(t){this.input=0,this.path="",this.tracePath=!0,this.scripting=t,this.warnOnInvalidGates=!1,this.RiScript=this.scripting.constructor}isCstNode(t){return typeof t=="object"&&("accept"in t||"name"in t&&"location"in t&&"children"in t)}visit(t,e){if(Array.isArray(t)&&(t=t[0]),typeof t>"u")return;if(!this.isCstNode(t))throw Error("Non-cstNode passed to visit: "+JSON.stringify(t));let{name:s,location:i}=t;if(this.nodeText=this.input.substring(i.startOffset,i.endOffset+1),typeof this[s]!="function")throw Error(`BaseVisitor.visit: expecting function for this[${s}], found ${typeof this[s]}: ${JSON.stringify(this[s])}`);return this.tracePath&&!/(expr|atom|silent)/.test(s)&&(this.path+=s+"."),this[s](t.children,e)}validateVisitor(){}},y=class extends w{constructor(t,e={}){super(t),this.context=e,this.trace=0,this.choices={},this.isNoRepeat=!1,this.symbols=this.scripting.Symbols,this.escaped=this.scripting.Escaped,this.statics={},this.dynamics={},this.pendingGates={},this.pendingSymbols=new Set,this.validateVisitor()}start(t={}){if(this.input=t.input,this.trace=t.trace,this.traceTx=t.traceTx,!t.cst)throw Error("no cst");return super.visit(t.cst)}script(t){this.order=0;let e=t.expr?t.expr.length:0;if(this.print("script","'"+this.RiScript._escapeText(this.input)+"' :: "+e+" expression(s)"),!e)return"";if(Object.keys(t).length!==1)throw Error("script: invalid expr");return this.visit(t.expr)}expr(t){let e=Object.keys(t);if(e.length!==1)throw Error("invalid expr: "+e.length);let s=t.atom.map(i=>this.visit(i));for(let i=1;i<s.length-1;i++)s[i].length===0&&s[i-1].endsWith(" ")&&s[i+1].startsWith(" ")&&(s[i+1]=s[i+1].substring(1));return s.join("")}wexpr(t){this.print("wexpr")}gate(t){if(t.Gate.length!==1)throw Error("Invalid gate: "+t.Gate);let e,s=t.Gate[0].image;try{e=this.scripting._query(s)}catch(l){if(!this.warnOnInvalidGates)throw Error(`Invalid gate[2]: "@${s}@"

RootCause -> ${l}`);return!this.scripting.RiTa.SILENT&&!this.scripting.silent&&console.warn(`[WARN] Ignoring invalid gate: @${s}@
`,l),{decision:"accept"}}let i={},r=[],n=e.operands();if(n.forEach(l=>{let{result:c,resolved:f,isStatic:g,isUser:p}=this.checkContext(l);typeof c=="function"&&(c=c.call(),f=!this.scripting.isParseable(c)),typeof c>"u"||!f?r.push(l):(g?this.statics[l]=c:p?this.context[l]=c:this.dynamics[l]=c,i[l]=c)}),Object.keys(i).length+r.length!==n.length)throw Error("invalid operands");if(r.length)return{decision:"defer",operands:r};let a=e.test(i);return!a&&this.castValues(i)&&(a=e.test(i)),{decision:a?"accept":"reject"}}assign(t,e){let s=t.SYM[0].image,i,r,n=s.replace(this.scripting.AnySymbolRE,"");if(s.startsWith(this.symbols.STATIC))i=this.visit(t.expr),this.scripting.isParseable(i)?(this.statics[n]=i,i=this.inlineAssignment(n,t.TF,i)):(this.statics[n]=i,this.pendingSymbols.delete(n),this.trace&&console.log("  [pending.delete]",s,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):"")),r=`${s} = ${this.RiScript._escapeText(i)} [#static] ${e?.silent?"{silent}":""}`;else{let l=this;i=()=>l.visit(t.expr),r=`${s} = <f*:pending>`+(e?.silent?"{silent}":""),this.dynamics[n]=i}return this.print("assign",r),i}silent(t){return t.EQ?this.assign(t,{silent:!0}):this.symbol(t,{silent:!0}),""}atom(t){let e,s=Object.keys(t);if(s.length!==1)throw Error("invalid atom: "+s);return this.scripting.parser.atomTypes.forEach(i=>{let r=t[i];if(r){if(r.length!==1)throw Error(i+": bad length -> "+t[i].length);e=this.visit(r[0])}}),typeof e=="function"&&(e=e.call()),e}text(t){if(t.Raw.length!==1)throw Error("[1] invalid text");if(Object.keys(t).length!==1)throw Error("[2] invalid text");let e=t.Raw[0].image;return this.print("text",this.RiScript._escapeText("'"+e+"'")),e}entity(t){return this.nodeText}symbol(t,e){if(t.SYM.length!==1)throw Error("[1] invalid symbol");let s=this.nodeText,i=t.SYM[0].image,r=i.replace(this.scripting.AnySymbolRE,"");if(this.isNoRepeat=this.hasNoRepeat(t.TF),this.pendingSymbols.has(r))return this.print("symbol",`${i} [is-pending]`),s;let{result:n,isStatic:a,isUser:l,resolved:c}=this.checkContext(r);if(!a&&i.startsWith(this.symbols.STATIC)&&!this.scripting.EntityRE.test(i))throw Error(`Attempt to refer to dynamic symbol '${r}' as ${this.symbols.STATIC}${r}, did you mean $${r}?`);if(typeof n=="function"&&(n=n.call(),c=!this.scripting.isParseable(n)),this.isNoRepeat&&(a||l)){this.isNoRepeat=!1;let g="Attempt to call norepeat() on "+(a?"static symbol '"+i+"'. Did you mean to use '"+this.symbols.DYNAMIC+r+"' ?":"non-dynamic symbol '"+r+"'. Did you mean to define '"+this.symbols.DYNAMIC+r+"' in riscript?");throw Error(g)}if(typeof n>"u")return this.print("symbol",i+" -> '"+s+"' ctx="+this.lookupsToString(),"[deferred]",e?.silent?"{silent}":""),s;let f=s+" -> '"+n+"'"+(e?.silent?" {silent}":"");return typeof n=="string"&&!c?(a?(this.pendingSymbols.add(r),n=this.inlineAssignment(r,t.TF,n),this.print("symbol*",`${s} -> ${n} :: pending.add(${r})`)):(t.TF&&(n=this.restoreTransforms(n,t.TF)),this.print("symbol",f)),n):(a&&(this.statics[r]=n),t.TF&&(n=this.applyTransforms(n,t.TF),f+=" -> '"+n+"'",this.isNoRepeat&&(f+=" (norepeat)")),this.print("symbol",f),this.pendingSymbols.has(r)&&(this.trace&&console.log("  [$pending.delete]",(a?"#":"$")+r,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):""),this.pendingSymbols.delete(r)),this.isNoRepeat=!1,n)}pgate(t){this.print("pgate",this.nodeText);let e=this.nodeText,s=e.replace(this.symbols.PENDING_GATE,""),i=this.pendingGates[s];if(!i)throw Error('no pending gate="'+e+'" pgates='+JSON.stringify(Object.keys(this.pendingGates)));return i.operands.some(a=>{let{result:l,resolved:c}=this.checkContext(a);return typeof l=="function"&&(l=l.call(),c=!this.scripting.isParseable(l)),typeof l>"u"||!c})?e:this.choice(i.deferredContext)}else(t){return this.visit(t.expr).trim()}choice(t,e){let s=this.symbols,i,r,n=this.nodeText,a=n,l=this.RiScript._stringHash(n+" #"+this.choiceId(t));if(!this.isNoRepeat&&this.hasNoRepeat(t.TF))throw Error("noRepeat() not allowed on choice (use a $variable instead): "+n);let c="accept";if(e?.forceReject)c="reject";else if(t.gate&&(i=t.gate[0].children.Gate[0].image,r=this.visit(t.gate),c=r.decision,a+=`
  [gate] ${i} -> ${c!=="defer"?c.toUpperCase():`DEFER ${s.PENDING_GATE}${l}`}  ${this.lookupsToString()}`),r&&r.decision==="defer")return this.pendingGates[l]={deferredContext:t,operands:r.operands},`${s.PENDING_GATE}${l}`;if(c==="reject"&&!("reject"in t))return"";let f=t[c]?.[0]?.children?.or_expr?.[0],g=this.parseOptions(f);if(!g)throw Error("No options in choice: "+n);let p=null,m=[],T=!1;for(;p===null;){if(p=this.choose(g,m).value,this.scripting.isParseable(p)){t.TF&&(p=this.restoreTransforms(p,t.TF)),T=!0;break}if(t.TF&&(p=this.applyTransforms(p,t.TF)),this.isNoRepeat&&p===this.choices[l]){this.print("choice.reject",p+" [norepeat]"),m.push(p),p=null;continue}}return T||(this.choices[l]=p),p}hasNoRepeat(t){let e=this.RiScript._transformNames(t);return e.length?e.includes("nr")||e.includes("norepeat"):!1}checkContext(t){let e=!1,s=!1,i;if(t.length===0)return{result:"",resolved:!0,isStatic:e,isUser:s};i=this.dynamics[t],typeof i>"u"&&(i=this.statics[t],typeof i<"u"&&(e=!0)),typeof i>"u"&&(i=this.context[t],typeof i<"u"?s=!0:i=this.context[this.symbols.DYNAMIC+t]);let r=!this.scripting.isParseable(i);return{result:i,isStatic:e,isUser:s,resolved:r}}inlineAssignment(t,e,s){let i=this.symbols,r=i.STATIC+t,n=this.restoreTransforms(s,e);return s=i.OPEN_CHOICE+(r+"="+n)+i.CLOSE_CHOICE,s}choiceId(t){if(!t.OC||!t.OC.length)throw Error("invalid choice");return t.OC[0].startOffset+"."+t.OC[0].endOffset}parseOptions(t){let e=[];if(t&&t?.children?.wexpr){let s=t.children.wexpr;for(let i=0;i<s.length;i++){let r=s[i],n=r.children.expr;if(n&&n.length!=1)throw Error("invalid choice-expr: "+n.length);let a=r.children.Weight;if(a){if(a.length!=1)throw Error("invalid weight: "+a.length);let l=1;try{l=parseInt(this.symbols.CLOSE_WEIGHT.length?a[0].image.trim().slice(1,-1):a[0].image.trim().slice(1))}catch{console.log("EX: "+l)}Array.from({length:l},()=>e.push(n))}else e.push(n||"")}}return e}chooseUnique(t,e){for(;t.length;){let{index:i,value:r}=this.choose(t);if(r!==this.choices[e])return r;t.splice(i,1)}throw Error("No remaining options")}choose(t,e=[]){if(!t||!t.length)throw Error("Invalid choice: no options");let s=t.filter(a=>!e.includes(a));if(!s.length)throw Error("Invalid choice: no valid options");let i=this.scripting.RiTa.randi(s.length),r="",n=s[i];return typeof n=="string"?this.print("choice.text","''"):(this.path="choice."+this.path,r=this.visit(n)),typeof r=="string"&&(r=r.trim()),{index:i,value:r}}applyTransforms(t,e){this.traceTx&&console.log("applyTransforms",this.formatTxs(...arguments));for(let s=0;s<e.length;s++)t=this.applyTransform(t,e[s]);return t}restoreTransforms(t,e){return typeof t=="string"&&(new RegExp("^"+this.escaped.OPEN_CHOICE+".*"+this.escaped.CLOSE_CHOICE+"$").test(t)||(t=this.symbols.OPEN_CHOICE+t+this.symbols.CLOSE_CHOICE),e&&e.forEach(i=>t+=i.image),this.traceTx&&console.log("restoreTransforms:",t)),t}castValues(t){let e=!1;return Object.entries(t).forEach(([s,i])=>{let r=parseFloat(i);isNaN(r)||(e=!0,t[s]=r)}),e}contextIsResolved(t){let e=!0;return Object.entries(t).forEach(([s,i])=>{this.scripting.isParseable(i)||(e=!1)}),e}applyTransform(t,e){let s=e.image,i,r=t+s,n=s.substring(1).replace(/\(\)$/,"");return typeof this.dynamics[n]=="function"?i=this.dynamics[n](t):typeof this.statics[n]=="function"?i=this.statics[n](t):typeof this.context[n]=="function"?i=this.context[n](t):typeof this.RiScript.transforms[n]=="function"?i=this.RiScript.transforms[n](t):typeof t[n]=="function"?i=t[n]():t.hasOwnProperty(n)?i=t[n]:(!this.scripting.RiTa.SILENT&&!this.scripting.silent&&console.warn("[WARN] Unresolved transform: "+r),i=r.replace(/\(\)$/,"&lpar;&rpar;")),this.trace&&console.log(`${this.tindent()}[transform] ${r} -> '${i}'`),i}lookupsToString(){let t={},e={};return Object.entries(this.dynamics||{}).forEach(([s,i])=>t[`$${s} `]=i),Object.entries(this.statics||{}).forEach(([s,i])=>e[`#${s} `]=i),JSON.stringify({...this.context,...e,...t},(s,i)=>typeof i=="function"?"<f*:pending>":i).replace(/"/g,"")}formatTxs(t,e){return t+e.map(s=>s.image.replace(/()/,"")+"()").join("")}print(t,...e){this.trace&&(this.path&&t!=="script"&&(t=this.path.replace(/\.$/,"")),console.log(++this.order,`[${t}]`,...e),this.path="")}tindent(){return" ".repeat((this.order+"").length+1)}};var{decode:D}=H,F=/[aeiou]/,O="_RE_",J=/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-fA-F]{1,6});/gi,b=class extends Y{constructor(t,e,s){if(typeof e=="string"){let i=e;e=t.parseJSOL(e)}super(e,s)}test(t){for(let e=0,s=this.compiled.length;e<s;e++)if(!this.compiled[e](t))return!1;return!0}operands(){let t=[this.condition],e=new Set;for(;t?.length>0;){let s=t.pop();Object.keys(s).forEach(i=>{let r=s[i];i.startsWith("$")||e.add(i),typeof r=="object"&&r!==null&&(Array.isArray(r)?r:[r]).forEach(a=>t.push(a))})}return Array.from(e)}},E=class{static evaluate(t,e,s={}){return new E().evaluate(t,e,s)}constructor(t={}){this.visitor=0,this.v2Compatible=t.compatibility===2;let{Constants:e,tokens:s}=I(this.v2Compatible);this.Escaped=e.Escaped,this.Symbols=e.Symbols;let i=e.Escaped.STATIC+e.Escaped.DYNAMIC,r=e.Escaped.OPEN_CHOICE,n=e.Escaped.CLOSE_CHOICE;this.JSOLIdentRE=new RegExp(`([${i}]?[A-Za-z_0-9][A-Za-z_0-9]*)\\s*:`,"g"),this.RawAssignRE=new RegExp(`^[${i}][A-Za-z_0-9][A-Za-z_0-9]*\\s*=`),this.ChoiceWrapRE=new RegExp("^"+r+"[^"+r+n+"]*"+n+"$"),this.SpecialRE=new RegExp(`[${this.Escaped.SPECIAL.replace("&","")}]`),this.ContinueRE=new RegExp(this.Escaped.CONTINUATION+"\\r?\\n","g"),this.WhitespaceRE=/[\u00a0\u2000-\u200b\u2028-\u2029\u3000]+/g,this.AnySymbolRE=new RegExp(`[${i}]`),this.silent=!1,this.lexer=new z(s),this.parser=new C(s),this.RiTa=t.RiTa||{VERSION:0,randi:a=>Math.floor(Math.random()*a)}}lex(t){if(!t.input)throw Error("no input");let e=this.lexer.tokenize(t.input);if(e.errors.length)throw console.error("Input: "+t.input+`
`,e.errors[0].message),Error("[LEXING] "+e.errors[0].message);t.trace&&this.printTokens(e.tokens),t.tokens=e.tokens}parse(t){t.cst=this.parser.parse(t)}visit(t){return this.visitor.start(t)}lexParseVisit(t={}){return this.lex(t),this.parse(t),this.visit(t)}evaluate(t,e,s={}){if(typeof t!="string")throw Error("RiScript.evaluate() expects a string, got "+typeof t);return s.input=t,s.visitor=new y(this,e),this._evaluate(s)}_evaluate(t){let{input:e}=t,s,i=/\r?\n$/.test(e),r=this.preParse(e,t);if(!r)return"";if(t.trace&&console.log(`
Input:  '${E._escapeText(e)}'`),t.trace&&e!==r&&console.log(`Parsed: '${E._escapeText(r)}'`),!t.visitor)throw Error("no visitor");this.visitor=t.visitor,delete t.visitor;for(let n=1;r!==s&&n<=10&&(s=r,t.trace&&console.log("-".repeat(20)+" Pass#"+n+" "+"-".repeat(20)),t.input=r,r=this.lexParseVisit(t),t.trace&&console.log(`Result(${n}) -> "${E._escapeText(r)}" ctx=${this.visitor.lookupsToString()}`),!(t.onepass||!this.isParseable(r)));n++);return!this.silent&&!this.RiTa.SILENT&&this.AnySymbolRE.test(r.replace(J,""))&&console.warn('[WARN] Unresolved symbol(s) in "'+r.replace(/\n/g,"\\n")+'" '),this.postParse(r,t)+(i?`
`:"")}_query(t,e){return new b(this,t,e)}printTokens(t){let e=t.reduce((s,i)=>{let{name:r}=i.tokenType,n=r;return n==="TEXT"&&(n=E._escapeText(i.image,1)),n==="SYM"&&(n="sym("+i.image+")"),n==="TX"&&(n="tx("+i.image+")"),s+n+", "},"").slice(0,-2);console.log(`
Tokens: [ `+e+" ]  Context:",this.visitor.lookupsToString())}postParse(t,e){if(typeof t!="string")return"";let i=D(t).replace(this.WhitespaceRE," ").replace(/\r?\n$/,"");return[...i.matchAll(this.Symbols.PENDING_GATE_RE)].forEach(n=>{if(!n||!n[0]||!n[1])throw Error("bad gate: "+n);let a=this.visitor.pendingGates[n[1]],{deferredContext:l,operands:c}=a;if(!c.length)throw Error("no operands");let f=this.visitor.choice(l,{forceReject:!0});i=i.replace(n[0],f),e.trace&&console.log("  "+n[0]+"-> "+f)}),e.trace&&console.log(`
Final: '${i}'`),e.preserveLookups||(this.visitor.statics=void 0,this.visitor.dynamics=void 0),i}preParse(t,e){if(typeof t!="string")return"";let s=this.Symbols,i=t;this.v2Compatible||(i=i.replace(/\((\s*\d+\s*)\)/g,"^$1^")),i=i.replace(/\/\*[^]*?(\r?\n)?\//g,""),i=i.replace(/\/\/[^\n]+(\r?\n|$)/g,""),i=i.replace(this.ContinueRE,""),i=q(i);let r="",n=i.split(/\r?\n/);for(let a=0;a<n.length;a++)if(this.RawAssignRE.test(n[a])){let l=n[a].indexOf("=");if(l<0)throw Error("invalid state: no assigment: "+n[a]);let c=n[a].substring(0,l),f=n[a].substring(l+1),g=N(f,s.OPEN_CHOICE),p=N(f,s.CLOSE_CHOICE);for(;g>p;){let m=n[++a];f+=`
`+m,g+=N(m,s.OPEN_CHOICE),p+=N(m,s.CLOSE_CHOICE)}r+=s.OPEN_SILENT+(c+"="+f)+s.CLOSE_SILENT}else r+=n[a],a<n.length-1&&(r+=`
`);return r}parseJSOL(t){let e=n=>{let a=n;if(typeof n=="string"&&n.startsWith(O)&&n.endsWith(O)){let l=n.split(O);if(l.length!==4)throw Error("invalid regex in unescape");a=new RegExp(l[1],l[2])}return a},s=E._escapeJSONRegex(t).replace(this.JSOLIdentRE,'"$1":').replace(/'/g,'"'),i=JSON.parse(s),r=e;return Object.keys(i).forEach(n=>i[n]=r(i[n])),i}isParseable(t){let e=!0;return/(string|number)/.test(typeof t)&&(e=this.SpecialRE.test(t.toString())),e}static articlize(t){if(!t||!t.length)return"";let e=t.split(/\s+/)[0];if(!E.RiTa?.phones)return E.RiTaWarnings.phones||(console.warn("[WARN] Install RiTa for proper phonemes"),E.RiTaWarnings.phones=!0),(/^[aeiou].*/i.test(e)?"an ":"a ")+t;let s=E.RiTa.phones(e,{silent:!0});return(s&&s.length&&F.test(s[0])?"an ":"a ")+t}static capitalize(t){return t?t[0].toUpperCase()+t.substring(1):""}static uppercase(t){return t?t.toUpperCase():""}static quotify(t){return"&#8220;"+(t||"")+"&#8221;"}static pluralize(t){return E.RiTa?.pluralize?E.RiTa.pluralize(t):(E.RiTaWarnings.plurals||(E.RiTaWarnings.plurals=!0,console.warn("[WARN] Install RiTa for proper pluralization")),t.endsWith("s")?t:t+"s")}static identity(t){return t}static _transformNames(t){return t&&t.length?t.map(e=>e.image.replace(/(^\.|\(\)$)/g,""),[]):[]}static _escapeText(t,e){if(typeof t!="string")return t;let s=t.replace(/\r?\n/g,"\\n");return e||!s.length?"'"+s+"'":s}static _escapeJSONRegex(t){return t.replace(/\/([^/]+?)\/([igmsuy]*)/g,`"${O}$1${O}$2${O}"`)}static _stringHash(t){let e,s=0;for(let r=0;r<t.length;r++)e=t.charCodeAt(r),s=(s<<5)-s+e,s|=0;let i=s.toString();return s<0?i.replace("-","0"):i}},h=E;R(h,"Query",b),R(h,"VERSION","[VI]{version}[/VI]"),R(h,"RiTaWarnings",{plurals:!1,phones:!1});h.transforms={quotify:h.quotify,pluralize:h.pluralize,capitalize:h.capitalize,articlize:h.articlize,uppercase:h.uppercase,norepeat:h.identity,art:h.articlize,nr:h.identity,cap:h.capitalize,ucf:h.capitalize,uc:h.uppercase,qq:h.quotify,s:h.pluralize};function q(o){return o=d(o,"\\(","&lpar;"),o=d(o,"\\)","&rpar;"),o=d(o,"\\[","&lsqb;"),o=d(o,"\\]","&rsqb;"),o=d(o,"\\{","&lcqb;"),o=d(o,"\\}","&rcqb;"),o=d(o,"\\@","&commat;"),o=d(o,"\\#","&num;"),o=d(o,"\\|"," &vert"),o=d(o,"\\="," &equals"),o}function B(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function d(o,t,e){return o.replace(new RegExp(B(t),"g"),()=>e)}function N(o,t){let e=0;for(let s=0;s<o.length;s++)o[s]===t&&e++;return e}var S=class{constructor(t={},e={}){if(typeof t!="object")throw Error("RiGrammar: expecting object, found "+typeof t);this.scripting=new h,this.context=e,this.setRules(t)}static expand(t,e,s){return new S(t,e).expand(s)}addTransform(){return h.addTransform(...arguments)}removeTransform(){return h.removeTransform(...arguments)}getTransforms(){return h.transforms}equals(t){return t.toJSON()===this.toJSON()}expand(t={}){if("context"in t)throw Error("pass context to RiScript.grammar() or new RiGrammar() instead");return t.visitor=t.visitor||new h.Visitor(this.scripting),t.visitor.context=this.context||{},t.input=this._toScript(t),this.scripting._evaluate(t)}addRule(t,e){this._validateRule(t,e),this.rules[t]=e}setRules(t){if(typeof t>"u")throw Error("undefined rules");this.rules={};let e=typeof t=="string"?V(t):t,s=this;Object.entries(e).forEach(i=>s.addRule(...i))}removeRule(t){t in this.rules&&delete this.rules[t]}toJSON(){return JSON.stringify(this.rules,...arguments)}toString(t={}){let e=t.replacer||0,s=t.space||2,i=t?.linebreak,r=this.toJSON(e,s);return i&&(r=r.replace(/\n/g,i)),r}static fromJSON(t,e){return new S(JSON.parse(t),e)}_toScript(t){let e="",s=t.start||"start",{Symbols:i}=this.scripting;if(s.startsWith(i.DYNAMIC)&&(s=s.substring(i.DYNAMIC.length)),s.startsWith(i.STATIC)&&(s=s.substring(i.STATIC.length)),!(s in this.rules||i.STATIC+s in this.rules))throw Error('Rule: "'+s+'" not found in grammar');return Object.entries(this.rules).forEach(([r,n],a)=>{for(;r.startsWith(i.DYNAMIC);)r=r.substring(1);r.startsWith(i.STATIC)||(r=i.DYNAMIC+r),this.scripting.ChoiceWrapRE.test(n)||(n=i.OPEN_CHOICE+n+i.CLOSE_CHOICE),e+=`${r}=${n}
`}),t.trace&&console.log(`Grammar:
`+e.replace(/^\$/gm,"  $")),e+=`${i.DYNAMIC}${s}`,e}_validateRule(t,e){if(typeof t!="string"||t.length===0)throw Error("expected [string] name");if(typeof e>"u")throw Error("undefined rule def: "+t);let{Symbols:s}=this.scripting;if(t.startsWith(s.DYNAMIC))throw t=t.substring(s.DYNAMIC.length),Error("Grammar rules are dynamic by default; if you need a static rule, use '"+s.STATIC+t+"', otherwise just use '"+t+"'.")}};function V(o){if(typeof o=="string")try{return JSON.parse(o)}catch{throw Error(`RiGrammar appears to be invalid JSON, please check it at http://jsonlint.com/
`+o)}}h.Grammar=S;h.Visitor=y;var St=h;export{St as default};
//# sourceMappingURL=index.js.map