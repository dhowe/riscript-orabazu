var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);import s from"he";import{Query as i}from"mingo";import{Lexer as r}from"chevrotain";import{createToken as n}from"chevrotain";import{CstParser as o}from"chevrotain";var a=class extends o{constructor(t){super(t,{nodeLocationTracking:"full"}),this.atomTypes=["silent","assign","symbol","choice","pgate","text","entity"],this.buildRules()}parse(t){this.input=t.tokens;let e=this.script();if(this.errors.length>0)throw Error("[PARSING]\n"+this.errors[0].message);return e}buildRules(){const t=this,e=this.tokensMap;t.RULE("script",(()=>{t.MANY((()=>t.SUBRULE(t.expr)))})),t.RULE("pgate",(()=>{t.CONSUME(e.PendingGate),t.MANY((()=>t.CONSUME(e.TF)))})),t.RULE("entity",(()=>{t.CONSUME(e.Entity)})),t.RULE("gate",(()=>{t.CONSUME(e.EnterGate),t.MANY((()=>t.CONSUME(e.Gate))),t.CONSUME(e.ExitGate)})),t.RULE("silent",(()=>{t.CONSUME(e.OS),t.OPTION1((()=>t.SUBRULE(t.gate))),t.CONSUME(e.SYM),t.OPTION2((()=>{t.CONSUME(e.EQ),t.SUBRULE(t.expr)})),t.CONSUME(e.CS)})),t.RULE("assign",(()=>{t.CONSUME(e.SYM),t.CONSUME(e.EQ),t.SUBRULE(t.expr)})),t.RULE("symbol",(()=>{t.CONSUME(e.SYM),t.MANY((()=>t.CONSUME(e.TF)))})),t.RULE("accept",(()=>{t.SUBRULE(t.or_expr)})),t.RULE("reject",(()=>{t.SUBRULE(t.or_expr)})),t.RULE("or_expr",(()=>{t.MANY_SEP({SEP:e.OR,DEF:()=>t.SUBRULE(t.wexpr)})})),t.RULE("choice",(()=>{t.CONSUME(e.OC),t.OPTION1((()=>t.SUBRULE(t.gate))),t.SUBRULE(t.accept),t.OPTION2((()=>{t.CONSUME(e.ELSE),t.SUBRULE(t.reject)})),t.CONSUME(e.CC),t.MANY((()=>t.CONSUME(e.TF)))})),t.RULE("wexpr",(()=>{t.MANY((()=>{t.OR([{ALT:()=>t.SUBRULE(t.expr)},{ALT:()=>t.CONSUME(e.Weight)}])}))})),t.RULE("expr",(()=>{t.AT_LEAST_ONE((()=>t.SUBRULE(t.atom)))})),t.RULE("atom",(()=>{t.OR(this.atomTypes.map((e=>({ALT:()=>t.SUBRULE(t[e])}))))})),t.RULE("text",(()=>{t.CONSUME(e.Raw)})),this.performSelfAnalysis()}},c=class{constructor(t){this.input=0,this.path="",this.tracePath=!0,this.scripting=t,this.warnOnInvalidGates=!1,this.RiScript=this.scripting.constructor}isCstNode(t){return"object"==typeof t&&("accept"in t||"name"in t&&"location"in t&&"children"in t)}visit(t,e){if(Array.isArray(t)&&(t=t[0]),void 0===t)return;if(!this.isCstNode(t))throw Error("Non-cstNode passed to visit: "+JSON.stringify(t));const{name:s,location:i}=t;if(this.nodeText=this.input.substring(i.startOffset,i.endOffset+1),"function"!=typeof this[s])throw Error(`BaseVisitor.visit: expecting function for this[${s}], found ${typeof this[s]}: ${JSON.stringify(this[s])}`);return this.tracePath&&!/(expr|atom|silent)/.test(s)&&(this.path+=s+"."),this[s](t.children,e)}validateVisitor(){}},l=class extends c{constructor(t,e={}){super(t),this.context=e,this.trace=0,this.choices={},this.isNoRepeat=!1,this.symbols=this.scripting.Symbols,this.escaped=this.scripting.Escaped,this.statics={},this.dynamics={},this.pendingGates={},this.pendingSymbols=new Set,this.validateVisitor()}start(t={}){if(this.input=t.input,this.trace=t.trace,this.traceTx=t.traceTx,!t.cst)throw Error("no cst");return super.visit(t.cst)}script(t){this.order=0;const e=t.expr?t.expr.length:0;if(this.print("script","'"+this.RiScript._escapeText(this.input)+"' :: "+e+" expression(s)"),!e)return"";if(1!==Object.keys(t).length)throw Error("script: invalid expr");return this.visit(t.expr)}expr(t){const e=Object.keys(t);if(1!==e.length)throw Error("invalid expr: "+e.length);const s=t.atom.map((t=>this.visit(t)));for(let t=1;t<s.length-1;t++)0===s[t].length&&s[t-1].endsWith(" ")&&s[t+1].startsWith(" ")&&(s[t+1]=s[t+1].substring(1));return s.join("")}wexpr(t){this.print("wexpr")}gate(t){if(1!==t.Gate.length)throw Error("Invalid gate: "+t.Gate);let e;const s=t.Gate[0].image;try{e=this.scripting._query(s)}catch(t){if(!this.warnOnInvalidGates)throw Error(`Invalid gate[2]: "@${s}@"\n\nRootCause -> ${t}`);return this.scripting.RiTa.SILENT||this.scripting.silent||console.warn(`[WARN] Ignoring invalid gate: @${s}@\n`,t),{decision:"accept"}}const i={},r=[],n=e.operands();if(n.forEach((t=>{let{result:e,resolved:s,isStatic:n,isUser:o}=this.checkContext(t);"function"==typeof e&&(e=e.call(),s=!this.scripting.isParseable(e)),void 0!==e&&s?(n?this.statics[t]=e:o?this.context[t]=e:this.dynamics[t]=e,i[t]=e):r.push(t)})),Object.keys(i).length+r.length!==n.length)throw Error("invalid operands");if(r.length)return{decision:"defer",operands:r};let o=e.test(i);return!o&&this.castValues(i)&&(o=e.test(i)),{decision:o?"accept":"reject"}}assign(t,e){const s=t.SYM[0].image;let i,r;const n=s.replace(this.scripting.AnySymbolRE,"");if(s.startsWith(this.symbols.STATIC))i=this.visit(t.expr),this.scripting.isParseable(i)?(this.statics[n]=i,i=this.inlineAssignment(n,t.TF,i)):(this.statics[n]=i,this.pendingSymbols.delete(n),this.trace&&console.log("  [pending.delete]",s,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):"")),r=`${s} = ${this.RiScript._escapeText(i)} [#static] ${e?.silent?"{silent}":""}`;else{const o=this;i=()=>o.visit(t.expr),r=`${s} = <f*:pending>`+(e?.silent?"{silent}":""),this.dynamics[n]=i}return this.print("assign",r),i}silent(t){return t.EQ?this.assign(t,{silent:!0}):this.symbol(t,{silent:!0}),""}atom(t){let e;const s=Object.keys(t);if(1!==s.length)throw Error("invalid atom: "+s);return this.scripting.parser.atomTypes.forEach((s=>{const i=t[s];if(i){if(1!==i.length)throw Error(s+": bad length -> "+t[s].length);e=this.visit(i[0])}})),"function"==typeof e&&(e=e.call()),e}text(t){if(1!==t.Raw.length)throw Error("[1] invalid text");if(1!==Object.keys(t).length)throw Error("[2] invalid text");const e=t.Raw[0].image;return this.print("text",this.RiScript._escapeText("'"+e+"'")),e}entity(t){return this.nodeText}symbol(t,e){if(1!==t.SYM.length)throw Error("[1] invalid symbol");const s=this.nodeText,i=t.SYM[0].image,r=i.replace(this.scripting.AnySymbolRE,"");if(this.isNoRepeat=this.hasNoRepeat(t.TF),this.pendingSymbols.has(r))return this.print("symbol",`${i} [is-pending]`),s;let{result:n,isStatic:o,isUser:a,resolved:c}=this.checkContext(r);if(!o&&i.startsWith(this.symbols.STATIC)&&!this.scripting.EntityRE.test(i))throw Error(`Attempt to refer to dynamic symbol '${r}' as ${this.symbols.STATIC}${r}, did you mean $${r}?`);if("function"==typeof n&&(n=n.call(),c=!this.scripting.isParseable(n)),this.isNoRepeat&&(o||a)){this.isNoRepeat=!1;const t="Attempt to call norepeat() on "+(o?"static symbol '"+i+"'. Did you mean to use '"+this.symbols.DYNAMIC+r+"' ?":"non-dynamic symbol '"+r+"'. Did you mean to define '"+this.symbols.DYNAMIC+r+"' in riscript?");throw Error(t)}if(void 0===n)return this.print("symbol",i+" -> '"+s+"' ctx="+this.lookupsToString(),"[deferred]",e?.silent?"{silent}":""),s;let l=s+" -> '"+n+"'"+(e?.silent?" {silent}":"");return"string"!=typeof n||c?(o&&(this.statics[r]=n),t.TF&&(n=this.applyTransforms(n,t.TF),l+=" -> '"+n+"'",this.isNoRepeat&&(l+=" (norepeat)")),this.print("symbol",l),this.pendingSymbols.has(r)&&(this.trace&&console.log("  [$pending.delete]",(o?"#":"$")+r,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):""),this.pendingSymbols.delete(r)),this.isNoRepeat=!1,n):(o?(this.pendingSymbols.add(r),n=this.inlineAssignment(r,t.TF,n),this.print("symbol*",`${s} -> ${n} :: pending.add(${r})`)):(t.TF&&(n=this.restoreTransforms(n,t.TF)),this.print("symbol",l)),n)}pgate(t){this.print("pgate",this.nodeText);const e=this.nodeText,s=e.replace(this.symbols.PENDING_GATE,""),i=this.pendingGates[s];if(!i)throw Error('no pending gate="'+e+'" pgates='+JSON.stringify(Object.keys(this.pendingGates)));if(i.operands.some((t=>{let{result:e,resolved:s}=this.checkContext(t);return"function"==typeof e&&(e=e.call(),s=!this.scripting.isParseable(e)),void 0===e||!s})))return e;return this.choice(i.deferredContext)}else(t){return this.visit(t.expr).trim()}choice(t,e){const s=this.symbols;let i,r;const n=this.nodeText;let o=n;const a=this.RiScript._stringHash(n+" #"+this.choiceId(t));if(!this.isNoRepeat&&this.hasNoRepeat(t.TF))throw Error("noRepeat() not allowed on choice (use a $variable instead): "+n);let c="accept";if(e?.forceReject)c="reject";else if(t.gate&&(i=t.gate[0].children.Gate[0].image,r=this.visit(t.gate),c=r.decision,o+=`\n  [gate] ${i} -> ${"defer"!==c?c.toUpperCase():`DEFER ${s.PENDING_GATE}${a}`}  ${this.lookupsToString()}`),r&&"defer"===r.decision)return this.pendingGates[a]={deferredContext:t,operands:r.operands},`${s.PENDING_GATE}${a}`;if("reject"===c&&!("reject"in t))return"";const l=t[c]?.[0]?.children?.or_expr?.[0],h=this.parseOptions(l);if(!h)throw Error("No options in choice: "+n);let p=null;const E=[];let g=!1;for(;null===p;){if(p=this.choose(h,E).value,this.scripting.isParseable(p)){t.TF&&(p=this.restoreTransforms(p,t.TF)),g=!0;break}t.TF&&(p=this.applyTransforms(p,t.TF)),this.isNoRepeat&&p===this.choices[a]&&(this.print("choice.reject",p+" [norepeat]"),E.push(p),p=null)}return g||(this.choices[a]=p),p}hasNoRepeat(t){const e=this.RiScript._transformNames(t);return!!e.length&&(e.includes("nr")||e.includes("norepeat"))}checkContext(t){let e,s=!1,i=!1;if(0===t.length)return{result:"",resolved:!0,isStatic:s,isUser:i};e=this.dynamics[t],void 0===e&&(e=this.statics[t],void 0!==e&&(s=!0)),void 0===e&&(e=this.context[t],void 0!==e?i=!0:e=this.context[this.symbols.DYNAMIC+t]);return{result:e,isStatic:s,isUser:i,resolved:!this.scripting.isParseable(e)}}inlineAssignment(t,e,s){const i=this.symbols,r=i.STATIC+t,n=this.restoreTransforms(s,e);return s=i.OPEN_CHOICE+(r+"=")+n+i.CLOSE_CHOICE}choiceId(t){if(!t.OC||!t.OC.length)throw Error("invalid choice");return t.OC[0].startOffset+"."+t.OC[0].endOffset}parseOptions(t){const e=[];if(t&&t?.children?.wexpr){const s=t.children.wexpr;for(let t=0;t<s.length;t++){const i=s[t],r=i.children.expr;if(r&&1!=r.length)throw Error("invalid choice-expr: "+r.length);const n=i.children.Weight;if(n){if(1!=n.length)throw Error("invalid weight: "+n.length);let t=1;try{t=parseInt(this.symbols.CLOSE_WEIGHT.length?n[0].image.trim().slice(1,-1):n[0].image.trim().slice(1))}catch(e){console.log("EX: "+t)}Array.from({length:t},(()=>e.push(r)))}else e.push(r||"")}}return e}chooseUnique(t,e){for(;t.length;){const{index:s,value:i}=this.choose(t);if(i!==this.choices[e])return i;t.splice(s,1)}throw Error("No remaining options")}choose(t,e=[]){if(!t||!t.length)throw Error("Invalid choice: no options");const s=t.filter((t=>!e.includes(t)));if(!s.length)throw Error("Invalid choice: no valid options");const i=this.scripting.RiTa.randi(s.length);let r="";const n=s[i];return"string"==typeof n?this.print("choice.text","''"):(this.path="choice."+this.path,r=this.visit(n)),"string"==typeof r&&(r=r.trim()),{index:i,value:r}}applyTransforms(t,e){this.traceTx&&console.log("applyTransforms",this.formatTxs(...arguments));for(let s=0;s<e.length;s++)t=this.applyTransform(t,e[s]);return t}restoreTransforms(t,e){if("string"==typeof t){new RegExp("^"+this.escaped.OPEN_CHOICE+".*"+this.escaped.CLOSE_CHOICE+"$").test(t)||(t=this.symbols.OPEN_CHOICE+t+this.symbols.CLOSE_CHOICE),e&&e.forEach((e=>t+=e.image)),this.traceTx&&console.log("restoreTransforms:",t)}return t}castValues(t){let e=!1;return Object.entries(t).forEach((([s,i])=>{const r=parseFloat(i);isNaN(r)||(e=!0,t[s]=r)})),e}contextIsResolved(t){let e=!0;return Object.entries(t).forEach((([t,s])=>{this.scripting.isParseable(s)||(e=!1)})),e}applyTransform(t,e){const s=e.image;let i;const r=t+s,n=s.substring(1).replace(/\(\)$/,"");return"function"==typeof this.dynamics[n]?i=this.dynamics[n](t):"function"==typeof this.statics[n]?i=this.statics[n](t):"function"==typeof this.context[n]?i=this.context[n](t):"function"==typeof this.RiScript.transforms[n]?i=this.RiScript.transforms[n](t):"function"==typeof t[n]?i=t[n]():t.hasOwnProperty(n)?i=t[n]:(this.scripting.RiTa.SILENT||this.scripting.silent||console.warn("[WARN] Unresolved transform: "+r),i=r.replace(/\(\)$/,"&lpar;&rpar;")),this.trace&&console.log(`${this.tindent()}[transform] ${r} -> '${i}'`),i}lookupsToString(){const t={},e={};return Object.entries(this.dynamics||{}).forEach((([e,s])=>t[`$${e} `]=s)),Object.entries(this.statics||{}).forEach((([t,s])=>e[`#${t} `]=s)),JSON.stringify({...this.context,...e,...t},((t,e)=>"function"==typeof e?"<f*:pending>":e)).replace(/"/g,"")}formatTxs(t,e){return t+e.map((t=>t.image.replace(/()/,"")+"()")).join("")}print(t,...e){this.trace&&(this.path&&"script"!==t&&(t=this.path.replace(/\.$/,"")),console.log(++this.order,`[${t}]`,...e),this.path="")}tindent(){return" ".repeat((this.order+"").length+1)}},{decode:h}=s,p=/[aeiou]/,E="_RE_",g=/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-fA-F]{1,6});/gi,u=class extends i{constructor(t,e,s){if("string"==typeof e){e=t.parseJSOL(e)}super(e,s)}test(t){for(let e=0,s=this.compiled.length;e<s;e++)if(!this.compiled[e](t))return!1;return!0}operands(){const t=[this.condition],e=new Set;for(;t?.length>0;){const s=t.pop();Object.keys(s).forEach((i=>{const r=s[i];if(i.startsWith("$")||e.add(i),"object"==typeof r&&null!==r){(Array.isArray(r)?r:[r]).forEach((e=>t.push(e)))}}))}return Array.from(e)}},f=class t{static evaluate(e,s,i={}){return(new t).evaluate(e,s,i)}constructor(t={}){this.visitor=0,this.v2Compatible=2===t.compatibility;const{Constants:e,tokens:s}=function(t){let e={OR:"|",ELSE:"||",DYNAMIC:"$",STATIC:"#",ENTITY:"&",OPEN_GATE:"@",CLOSE_GATE:"@",PENDING_GATE:"@@",OPEN_SILENT:"{",CLOSE_SILENT:"}"};Object.assign(e,t?{OPEN_CHOICE:"(",CLOSE_CHOICE:")",OPEN_WEIGHT:"[",CLOSE_WEIGHT:"]",CONTINUATION:"\\"}:{OPEN_CHOICE:"[",CLOSE_CHOICE:"]",OPEN_WEIGHT:"^",CLOSE_WEIGHT:"^",CONTINUATION:"~"});const s={};Object.entries(e).forEach((([t,e])=>{s[t]=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}));const i=new RegExp(`${s.PENDING_GATE}([0-9]{9,11})`);s.SPECIAL=Object.values(s).join("").replace(/[<>]/g,""),e.PENDING_GATE_RE=new RegExp(i.source,"g");const r=n({name:"ExitGate",pattern:new RegExp(`\\s*${s.CLOSE_GATE}`),pop_mode:!0}),o=n({name:"Gate",pattern:new RegExp(`[^${s.CLOSE_GATE}]+`)}),a=n({name:"PendingGate",pattern:i}),c=n({name:"EnterGate",pattern:new RegExp(`${s.OPEN_GATE}\\s*`),push_mode:"gate_mode"}),l=n({name:"OC",pattern:new RegExp(s.OPEN_CHOICE+"\\s*")}),h=n({name:"CC",pattern:new RegExp(`\\s*${s.CLOSE_CHOICE}`)}),p=n({name:"OR",pattern:/\s*\|\s*/}),E=n({name:"ELSE",pattern:/\s*\|\|\s*/}),g=n({name:"EQ",pattern:/\s*=\s*/}),u=n({name:"TF",pattern:/\.[A-Za-z_0-9][A-Za-z_0-9]*(\(\))?/}),f=n({name:"OS",pattern:new RegExp(`${s.OPEN_SILENT}\\s*`)}),d=n({name:"CS",pattern:new RegExp(`\\s*${s.CLOSE_SILENT}`)}),m=n({name:"SYM",pattern:new RegExp(`[${s.DYNAMIC}${s.STATIC}][A-Za-z_0-9]*`)});return{tokens:{modes:{normal:[n({name:"Entity",pattern:/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-fA-F]{1,6});/i}),n({name:"Weight",pattern:new RegExp(`\\s*${s.OPEN_WEIGHT}.+${s.CLOSE_WEIGHT}\\s*`)}),E,l,h,p,g,m,u,f,d,a,n({name:"Raw",pattern:new RegExp(`[^${s.SPECIAL}]+`)}),c],gate_mode:[o,r]},defaultMode:"normal"},Constants:{Symbols:e,Escaped:s}}}(this.v2Compatible);this.Escaped=e.Escaped,this.Symbols=e.Symbols;const i=e.Escaped.STATIC+e.Escaped.DYNAMIC,o=e.Escaped.OPEN_CHOICE,c=e.Escaped.CLOSE_CHOICE;this.JSOLIdentRE=new RegExp(`([${i}]?[A-Za-z_0-9][A-Za-z_0-9]*)\\s*:`,"g"),this.RawAssignRE=new RegExp(`^[${i}][A-Za-z_0-9][A-Za-z_0-9]*\\s*=`),this.ChoiceWrapRE=new RegExp("^"+o+"[^"+o+c+"]*"+c+"$"),this.SpecialRE=new RegExp(`[${this.Escaped.SPECIAL.replace("&","")}]`),this.ContinueRE=new RegExp(this.Escaped.CONTINUATION+"\\r?\\n","g"),this.WhitespaceRE=/[\u00a0\u2000-\u200b\u2028-\u2029\u3000]+/g,this.AnySymbolRE=new RegExp(`[${i}]`),this.silent=!1,this.lexer=new r(s),this.parser=new a(s),this.RiTa=t.RiTa||{VERSION:0,randi:t=>Math.floor(Math.random()*t)}}lex(t){if(!t.input)throw Error("no input");const e=this.lexer.tokenize(t.input);if(e.errors.length)throw console.error("Input: "+t.input+"\n",e.errors[0].message),Error("[LEXING] "+e.errors[0].message);t.trace&&this.printTokens(e.tokens),t.tokens=e.tokens}parse(t){t.cst=this.parser.parse(t)}visit(t){return this.visitor.start(t)}lexParseVisit(t={}){return this.lex(t),this.parse(t),this.visit(t)}evaluate(t,e,s={}){if("string"!=typeof t)throw Error("RiScript.evaluate() expects a string, got "+typeof t);return s.input=t,s.visitor=new l(this,e),this._evaluate(s)}_evaluate(e){const{input:s}=e;let i,r=/\r?\n$/.test(s),n=this.preParse(s,e);if(!n)return"";if(e.trace&&console.log(`\nInput:  '${t._escapeText(s)}'`),e.trace&&s!==n&&console.log(`Parsed: '${t._escapeText(n)}'`),!e.visitor)throw Error("no visitor");this.visitor=e.visitor,delete e.visitor;for(let s=1;n!==i&&s<=10&&(i=n,e.trace&&console.log("-".repeat(20)+" Pass#"+s+" "+"-".repeat(20)),e.input=n,n=this.lexParseVisit(e),e.trace&&console.log(`Result(${s}) -> "${t._escapeText(n)}" ctx=${this.visitor.lookupsToString()}`),!e.onepass&&this.isParseable(n));s++);return this.silent||this.RiTa.SILENT||this.AnySymbolRE.test(n.replace(g,""))&&console.warn('[WARN] Unresolved symbol(s) in "'+n.replace(/\n/g,"\\n")+'" '),this.postParse(n,e)+(r?"\n":"")}_query(t,e){return new u(this,t,e)}printTokens(e){let s=e.reduce(((e,s)=>{let{name:i}=s.tokenType,r=i;return"TEXT"===r&&(r=t._escapeText(s.image,1)),"SYM"===r&&(r="sym("+s.image+")"),"TX"===r&&(r="tx("+s.image+")"),e+r+", "}),"").slice(0,-2);console.log("\nTokens: [ "+s+" ]  Context:",this.visitor.lookupsToString())}postParse(t,e){if("string"!=typeof t)return"";let s=h(t).replace(this.WhitespaceRE," ").replace(/\r?\n$/,"");return[...s.matchAll(this.Symbols.PENDING_GATE_RE)].forEach((t=>{if(!t||!t[0]||!t[1])throw Error("bad gate: "+t);let i=this.visitor.pendingGates[t[1]],{deferredContext:r,operands:n}=i;if(!n.length)throw Error("no operands");let o=this.visitor.choice(r,{forceReject:!0});s=s.replace(t[0],o),e.trace&&console.log("  "+t[0]+"-> "+o)})),e.trace&&console.log(`\nFinal: '${s}'`),e.preserveLookups||(this.visitor.statics=void 0,this.visitor.dynamics=void 0),s}preParse(t,e){if("string"!=typeof t)return"";const s=this.Symbols;let i=t;var r;this.v2Compatible||(i=i.replace(/\((\s*\d+\s*)\)/g,"^$1^")),i=i.replace(/\/\*[^]*?(\r?\n)?\//g,""),i=i.replace(/\/\/[^\n]+(\r?\n|$)/g,""),i=i.replace(this.ContinueRE,""),r=m(r=i,"\\(","&lpar;"),r=m(r,"\\)","&rpar;"),r=m(r,"\\[","&lsqb;"),r=m(r,"\\]","&rsqb;"),r=m(r,"\\{","&lcqb;"),r=m(r,"\\}","&rcqb;"),r=m(r,"\\@","&commat;"),r=m(r,"\\#","&num;"),r=m(r,"\\|"," &vert"),i=r=m(r,"\\="," &equals");let n="",o=i.split(/\r?\n/);for(let t=0;t<o.length;t++)if(
/*!opts.noAddedSilence && */
this.RawAssignRE.test(o[t])){let e=o[t].indexOf("=");if(e<0)throw Error("invalid state: no assigment: "+o[t]);let i=o[t].substring(0,e),r=o[t].substring(e+1),a=S(r,s.OPEN_CHOICE),c=S(r,s.CLOSE_CHOICE);for(;a>c;){let e=o[++t];r+="\n"+e,a+=S(e,s.OPEN_CHOICE),c+=S(e,s.CLOSE_CHOICE)}n+=s.OPEN_SILENT+(i+"=")+r+s.CLOSE_SILENT}else n+=o[t],t<o.length-1&&(n+="\n");return n}parseJSOL(e){let s=t._escapeJSONRegex(e).replace(this.JSOLIdentRE,'"$1":').replace(/'/g,'"'),i=JSON.parse(s),r=t=>{let e=t;if("string"==typeof t&&t.startsWith(E)&&t.endsWith(E)){let s=t.split(E);if(4!==s.length)throw Error("invalid regex in unescape");e=new RegExp(s[1],s[2])}return e};return Object.keys(i).forEach((t=>i[t]=r(i[t]))),i}isParseable(t){let e=!0;return/(string|number)/.test(typeof t)&&(e=this.SpecialRE.test(t.toString())),e}static articlize(e){if(!e||!e.length)return"";let s=e.split(/\s+/)[0];if(!t.RiTa?.phones)return t.RiTaWarnings.phones||(console.warn("[WARN] Install RiTa for proper phonemes"),t.RiTaWarnings.phones=!0),(/^[aeiou].*/i.test(s)?"an ":"a ")+e;let i=t.RiTa.phones(s,{silent:!0});return(i&&i.length&&p.test(i[0])?"an ":"a ")+e}static capitalize(t){return t?t[0].toUpperCase()+t.substring(1):""}static uppercase(t){return t?t.toUpperCase():""}static quotify(t){return"&#8220;"+(t||"")+"&#8221;"}static pluralize(e){return t.RiTa?.pluralize?t.RiTa.pluralize(e):(t.RiTaWarnings.plurals||(t.RiTaWarnings.plurals=!0,console.warn("[WARN] Install RiTa for proper pluralization")),e.endsWith("s")?e:e+"s")}static identity(t){return t}static _transformNames(t){return t&&t.length?t.map((t=>t.image.replace(/(^\.|\(\)$)/g,"")),[]):[]}static _escapeText(t,e){if("string"!=typeof t)return t;let s=t.replace(/\r?\n/g,"\\n");return e||!s.length?"'"+s+"'":s}static _escapeJSONRegex(t){return t.replace(/\/([^/]+?)\/([igmsuy]*)/g,`"${E}$1${E}$2${E}"`)}static _stringHash(t){let e,s=0;for(let i=0;i<t.length;i++)e=t.charCodeAt(i),s=(s<<5)-s+e,s|=0;let i=s.toString();return s<0?i.replace("-","0"):i}};e(f,"Query",u),e(f,"VERSION","1.0.19"),e(f,"RiTaWarnings",{plurals:!1,phones:!1});var d=f;function m(t,e,s){return t.replace(new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),(()=>s))}function S(t,e){let s=0;for(let i=0;i<t.length;i++)t[i]===e&&s++;return s}d.transforms={quotify:d.quotify,pluralize:d.pluralize,capitalize:d.capitalize,articlize:d.articlize,uppercase:d.uppercase,norepeat:d.identity,art:d.articlize,nr:d.identity,cap:d.capitalize,ucf:d.capitalize,uc:d.uppercase,qq:d.quotify,s:d.pluralize};d.Grammar=class t{constructor(t={},e={}){if("object"!=typeof t)throw Error("RiGrammar: expecting object, found "+typeof t);this.scripting=new d,this.context=e,this.setRules(t)}static expand(e,s,i){return new t(e,s).expand(i)}addTransform(){return d.addTransform(...arguments)}removeTransform(){return d.removeTransform(...arguments)}getTransforms(){return d.transforms}equals(t){return t.toJSON()===this.toJSON()}expand(t={}){if("context"in t)throw Error("pass context to RiScript.grammar() or new RiGrammar() instead");return t.visitor=t.visitor||new d.Visitor(this.scripting),t.visitor.context=this.context||{},t.input=this._toScript(t),this.scripting._evaluate(t)}addRule(t,e){this._validateRule(t,e),this.rules[t]=e}setRules(t){if(void 0===t)throw Error("undefined rules");this.rules={};let e="string"==typeof t?function(t){if("string"==typeof t)try{return JSON.parse(t)}catch(e){throw Error("RiGrammar appears to be invalid JSON, please check it at http://jsonlint.com/\n"+t)}}(t):t,s=this;Object.entries(e).forEach((t=>s.addRule(...t)))}removeRule(t){t in this.rules&&delete this.rules[t]}toJSON(){return JSON.stringify(this.rules,...arguments)}toString(t={}){let e=t.replacer||0,s=t.space||2,i=t?.linebreak,r=this.toJSON(e,s);return i&&(r=r.replace(/\n/g,i)),r}static fromJSON(e,s){return new t(JSON.parse(e),s)}_toScript(t){let e="",s=t.start||"start",{Symbols:i}=this.scripting;if(s.startsWith(i.DYNAMIC)&&(s=s.substring(i.DYNAMIC.length)),s.startsWith(i.STATIC)&&(s=s.substring(i.STATIC.length)),!(s in this.rules)&&!(i.STATIC+s in this.rules))throw Error('Rule: "'+s+'" not found in grammar');return Object.entries(this.rules).forEach((([t,s],r)=>{for(;t.startsWith(i.DYNAMIC);)t=t.substring(1);t.startsWith(i.STATIC)||(t=i.DYNAMIC+t),this.scripting.ChoiceWrapRE.test(s)||(s=i.OPEN_CHOICE+s+i.CLOSE_CHOICE),e+=`${t}=${s}\n`})),t.trace&&console.log("Grammar:\n"+e.replace(/^\$/gm,"  $")),e+=`${i.DYNAMIC}${s}`,e}_validateRule(t,e){if("string"!=typeof t||0===t.length)throw Error("expected [string] name");if(void 0===e)throw Error("undefined rule def: "+t);let{Symbols:s}=this.scripting;if(t.startsWith(s.DYNAMIC))throw t=t.substring(s.DYNAMIC.length),Error("Grammar rules are dynamic by default; if you need a static rule, use '"+s.STATIC+t+"', otherwise just use '"+t+"'.")}},d.Visitor=l;var y=d;export{y as default};//# sourceMappingURL=riscript.js.map