var G=Object.defineProperty;var M=(a,e,t)=>e in a?G(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var O=(a,e,t)=>(M(a,typeof e!="symbol"?e+"":e,t),t);import j from"he";import{Query as H}from"mingo";import{Lexer as z}from"chevrotain";import{createToken as E}from"chevrotain";function w(a){let e={OR:"|",ELSE:"||",DYNAMIC:"$",STATIC:"#",ENTITY:"&",OPEN_GATE:"@",CLOSE_GATE:"@",PENDING_GATE:"@@",OPEN_SILENT:"{",CLOSE_SILENT:"}"};Object.assign(e,a?{OPEN_CHOICE:"(",CLOSE_CHOICE:")",OPEN_WEIGHT:"[",CLOSE_WEIGHT:"]",CONTINUATION:"\\"}:{OPEN_CHOICE:"[",CLOSE_CHOICE:"]",OPEN_WEIGHT:"^",CLOSE_WEIGHT:"^",CONTINUATION:"~"});let i={};Object.entries(e).forEach(([_,P])=>{i[_]=k(P)});let n=new RegExp(`${i.PENDING_GATE}([0-9]{9,11})`);i.SPECIAL=Object.values(i).join("").replace(/[<>]/g,""),e.PENDING_GATE_RE=new RegExp(n.source,"g");let r=E({name:"ExitGate",pattern:new RegExp(`\\s*${i.CLOSE_GATE}`),pop_mode:!0}),o=E({name:"Gate",pattern:new RegExp(`[^${i.CLOSE_GATE}]+`)}),l=E({name:"PendingGate",pattern:n}),c=E({name:"EnterGate",pattern:new RegExp(`${i.OPEN_GATE}\\s*`),push_mode:"gate_mode"}),p=E({name:"OC",pattern:new RegExp(i.OPEN_CHOICE+"\\s*")}),g=E({name:"CC",pattern:new RegExp(`\\s*${i.CLOSE_CHOICE}`)}),h=E({name:"OR",pattern:/\s*\|\s*/}),m=E({name:"ELSE",pattern:/\s*\|\|\s*/}),S=E({name:"EQ",pattern:/\s*=\s*/}),x=E({name:"TF",pattern:/\.[A-Za-z_0-9][A-Za-z_0-9]*(\(\))?/}),I=E({name:"OS",pattern:new RegExp(`${i.OPEN_SILENT}\\s*`)}),$=E({name:"CS",pattern:new RegExp(`\\s*${i.CLOSE_SILENT}`)}),A=E({name:"SYM",pattern:new RegExp(`[${i.DYNAMIC}${i.STATIC}][A-Za-z_0-9]*`)}),v=E({name:"Entity",pattern:/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-fA-F]{1,6});/i}),U=E({name:"Weight",pattern:new RegExp(`\\s*${i.OPEN_WEIGHT}.+${i.CLOSE_WEIGHT}\\s*`)}),L=E({name:"Raw",pattern:new RegExp(`[^${i.SPECIAL}]+`)});return{tokens:{modes:{normal:[v,U,m,p,g,h,S,A,x,I,$,l,L,c],gate_mode:[o,r]},defaultMode:"normal"},Constants:{Symbols:e,Escaped:i}}}function k(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}import{CstParser as W}from"chevrotain";var T=class extends W{constructor(e){super(e,{nodeLocationTracking:"full"}),this.atomTypes=["silent","assign","symbol","choice","pgate","text","entity"],this.buildRules()}parse(e){this.input=e.tokens;let t=this.script();if(this.errors.length>0)throw Error(`[PARSING]
`+this.errors[0].message);return t}buildRules(){let e=this,t=this.tokensMap;e.RULE("script",()=>{e.MANY(()=>e.SUBRULE(e.expr))}),e.RULE("pgate",()=>{e.CONSUME(t.PendingGate),e.MANY(()=>e.CONSUME(t.TF))}),e.RULE("entity",()=>{e.CONSUME(t.Entity)}),e.RULE("gate",()=>{e.CONSUME(t.EnterGate),e.MANY(()=>e.CONSUME(t.Gate)),e.CONSUME(t.ExitGate)}),e.RULE("silent",()=>{e.CONSUME(t.OS),e.OPTION1(()=>e.SUBRULE(e.gate)),e.CONSUME(t.SYM),e.OPTION2(()=>{e.CONSUME(t.EQ),e.SUBRULE(e.expr)}),e.CONSUME(t.CS)}),e.RULE("assign",()=>{e.CONSUME(t.SYM),e.CONSUME(t.EQ),e.SUBRULE(e.expr)}),e.RULE("symbol",()=>{e.CONSUME(t.SYM),e.MANY(()=>e.CONSUME(t.TF))}),e.RULE("accept",()=>{e.SUBRULE(e.or_expr)}),e.RULE("reject",()=>{e.SUBRULE(e.or_expr)}),e.RULE("or_expr",()=>{e.MANY_SEP({SEP:t.OR,DEF:()=>e.SUBRULE(e.wexpr)})}),e.RULE("choice",()=>{e.CONSUME(t.OC),e.OPTION1(()=>e.SUBRULE(e.gate)),e.SUBRULE(e.accept),e.OPTION2(()=>{e.CONSUME(t.ELSE),e.SUBRULE(e.reject)}),e.CONSUME(t.CC),e.MANY(()=>e.CONSUME(t.TF))}),e.RULE("wexpr",()=>{e.MANY(()=>{e.OR([{ALT:()=>e.SUBRULE(e.expr)},{ALT:()=>e.CONSUME(t.Weight)}])})}),e.RULE("expr",()=>{e.AT_LEAST_ONE(()=>e.SUBRULE(e.atom))}),e.RULE("atom",()=>{e.OR(this.atomTypes.map(s=>({ALT:()=>e.SUBRULE(e[s])})))}),e.RULE("text",()=>{e.CONSUME(t.Raw)}),this.performSelfAnalysis()}};var b=class{constructor(e){this.input=0,this.path="",this.tracePath=!0,this.scripting=e,this.warnOnInvalidGates=!1,this.RiScript=this.scripting.constructor}isCstNode(e){return typeof e=="object"&&("accept"in e||"name"in e&&"location"in e&&"children"in e)}visit(e,t){if(Array.isArray(e)&&(e=e[0]),typeof e>"u")return;if(!this.isCstNode(e))throw Error("Non-cstNode passed to visit: "+JSON.stringify(e));let{name:s,location:i}=e;if(this.nodeText=this.input.substring(i.startOffset,i.endOffset+1),typeof this[s]!="function")throw Error(`BaseVisitor.visit: expecting function for this[${s}], found ${typeof this[s]}: ${JSON.stringify(this[s])}`);return this.tracePath&&!/(expr|atom|silent)/.test(s)&&(this.path+=s+"."),this[s](e.children,t)}validateVisitor(){}},R=class extends b{constructor(e,t={}){super(e),this.context=t,this.trace=0,this.choices={},this.isNoRepeat=!1,this.symbols=this.scripting.Symbols,this.escaped=this.scripting.Escaped,this.statics={},this.dynamics={},this.pendingGates={},this.pendingSymbols=new Set,this.validateVisitor()}start(e={}){if(this.input=e.input,this.trace=e.trace,this.traceTx=e.traceTx,!e.cst)throw Error("no cst");return super.visit(e.cst)}script(e){this.order=0;let t=e.expr?e.expr.length:0;if(this.print("script","'"+this.RiScript._escapeText(this.input)+"' :: "+t+" expression(s)"),!t)return"";if(Object.keys(e).length!==1)throw Error("script: invalid expr");return this.visit(e.expr)}expr(e){let t=Object.keys(e);if(t.length!==1)throw Error("invalid expr: "+t.length);let s=e.atom.map(i=>this.visit(i));for(let i=1;i<s.length-1;i++)s[i].length===0&&s[i-1].endsWith(" ")&&s[i+1].startsWith(" ")&&(s[i+1]=s[i+1].substring(1));return s.join("")}wexpr(e){this.print("wexpr")}gate(e){if(e.Gate.length!==1)throw Error("Invalid gate: "+e.Gate);let t,s=e.Gate[0].image;try{t=this.scripting._query(s)}catch(l){if(!this.warnOnInvalidGates)throw Error(`Invalid gate[2]: "@${s}@"

RootCause -> ${l}`);return!this.scripting.RiTa.SILENT&&!this.scripting.silent&&console.warn(`[WARN] Ignoring invalid gate: @${s}@
`,l),{decision:"accept"}}let i={},n=[],r=t.operands();if(r.forEach(l=>{let{result:c,resolved:p,isStatic:g,isUser:h}=this.checkContext(l);typeof c=="function"&&(c=c.call(),p=!this.scripting.isParseable(c)),typeof c>"u"||!p?n.push(l):(g?this.statics[l]=c:h?this.context[l]=c:this.dynamics[l]=c,i[l]=c)}),Object.keys(i).length+n.length!==r.length)throw Error("invalid operands");if(n.length)return{decision:"defer",operands:n};let o=t.test(i);return!o&&this.castValues(i)&&(o=t.test(i)),{decision:o?"accept":"reject"}}assign(e,t){let s=e.SYM[0].image,i,n,r=s.replace(this.scripting.AnySymbolRE,"");if(s.startsWith(this.symbols.STATIC))i=this.visit(e.expr),this.scripting.isParseable(i)?(this.statics[r]=i,i=this.inlineAssignment(r,e.TF,i)):(this.statics[r]=i,this.pendingSymbols.delete(r),this.trace&&console.log("  [pending.delete]",s,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):"")),n=`${s} = ${this.RiScript._escapeText(i)} [#static] ${t?.silent?"{silent}":""}`;else{let l=this;i=()=>l.visit(e.expr),n=`${s} = <f*:pending>`+(t?.silent?"{silent}":""),this.dynamics[r]=i}return this.print("assign",n),i}silent(e){return e.EQ?this.assign(e,{silent:!0}):this.symbol(e,{silent:!0}),""}atom(e){let t,s=Object.keys(e);if(s.length!==1)throw Error("invalid atom: "+s);return this.scripting.parser.atomTypes.forEach(i=>{let n=e[i];if(n){if(n.length!==1)throw Error(i+": bad length -> "+e[i].length);t=this.visit(n[0])}}),typeof t=="function"&&(t=t.call()),t}text(e){if(e.Raw.length!==1)throw Error("[1] invalid text");if(Object.keys(e).length!==1)throw Error("[2] invalid text");let t=e.Raw[0].image;return this.print("text",this.RiScript._escapeText("'"+t+"'")),t}entity(e){return this.nodeText}symbol(e,t){if(e.SYM.length!==1)throw Error("[1] invalid symbol");let s=this.nodeText,i=e.SYM[0].image,n=i.replace(this.scripting.AnySymbolRE,"");if(this.isNoRepeat=this.hasNoRepeat(e.TF),this.pendingSymbols.has(n))return this.print("symbol",`${i} [is-pending]`),s;let{result:r,isStatic:o,isUser:l,resolved:c}=this.checkContext(n);if(!o&&i.startsWith(this.symbols.STATIC)&&!this.scripting.EntityRE.test(i))throw Error(`Attempt to refer to dynamic symbol '${n}' as ${this.symbols.STATIC}${n}, did you mean $${n}?`);if(typeof r=="function"&&(r=r.call(),c=!this.scripting.isParseable(r)),this.isNoRepeat&&(o||l)){this.isNoRepeat=!1;let g="Attempt to call norepeat() on "+(o?"static symbol '"+i+"'. Did you mean to use '"+this.symbols.DYNAMIC+n+"' ?":"non-dynamic symbol '"+n+"'. Did you mean to define '"+this.symbols.DYNAMIC+n+"' in riscript?");throw Error(g)}if(typeof r>"u")return this.print("symbol",i+" -> '"+s+"' ctx="+this.lookupsToString(),"[deferred]",t?.silent?"{silent}":""),s;let p=s+" -> '"+r+"'"+(t?.silent?" {silent}":"");return typeof r=="string"&&!c?(o?(this.pendingSymbols.add(n),r=this.inlineAssignment(n,e.TF,r),this.print("symbol*",`${s} -> ${r} :: pending.add(${n})`)):(e.TF&&(r=this.restoreTransforms(r,e.TF)),this.print("symbol",p)),r):(o&&(this.statics[n]=r),e.TF&&(r=this.applyTransforms(r,e.TF),p+=" -> '"+r+"'",this.isNoRepeat&&(p+=" (norepeat)")),this.print("symbol",p),this.pendingSymbols.has(n)&&(this.trace&&console.log("  [$pending.delete]",(o?"#":"$")+n,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):""),this.pendingSymbols.delete(n)),this.isNoRepeat=!1,r)}pgate(e){this.print("pgate",this.nodeText);let t=this.nodeText,s=t.replace(this.symbols.PENDING_GATE,""),i=this.pendingGates[s];if(!i)throw Error('no pending gate="'+t+'" pgates='+JSON.stringify(Object.keys(this.pendingGates)));return i.operands.some(o=>{let{result:l,resolved:c}=this.checkContext(o);return typeof l=="function"&&(l=l.call(),c=!this.scripting.isParseable(l)),typeof l>"u"||!c})?t:this.choice(i.deferredContext)}else(e){return this.visit(e.expr).trim()}choice(e,t){let s=this.symbols,i,n,r=this.nodeText,o=r,l=this.RiScript._stringHash(r+" #"+this.choiceId(e));if(!this.isNoRepeat&&this.hasNoRepeat(e.TF))throw Error("noRepeat() not allowed on choice (use a $variable instead): "+r);let c="accept";if(t?.forceReject)c="reject";else if(e.gate&&(i=e.gate[0].children.Gate[0].image,n=this.visit(e.gate),c=n.decision,o+=`
  [gate] ${i} -> ${c!=="defer"?c.toUpperCase():`DEFER ${s.PENDING_GATE}${l}`}  ${this.lookupsToString()}`),n&&n.decision==="defer")return this.pendingGates[l]={deferredContext:e,operands:n.operands},`${s.PENDING_GATE}${l}`;if(c==="reject"&&!("reject"in e))return"";let p=e[c]?.[0]?.children?.or_expr?.[0],g=this.parseOptions(p);if(!g)throw Error("No options in choice: "+r);let h=null,m=[],S=!1;for(;h===null;){if(h=this.choose(g,m).value,this.scripting.isParseable(h)){e.TF&&(h=this.restoreTransforms(h,e.TF)),S=!0;break}if(e.TF&&(h=this.applyTransforms(h,e.TF)),this.isNoRepeat&&h===this.choices[l]){this.print("choice.reject",h+" [norepeat]"),m.push(h),h=null;continue}}return S||(this.choices[l]=h),h}hasNoRepeat(e){let t=this.RiScript._transformNames(e);return t.length?t.includes("nr")||t.includes("norepeat"):!1}checkContext(e){let t=!1,s=!1,i;if(e.length===0)return{result:"",resolved:!0,isStatic:t,isUser:s};i=this.dynamics[e],typeof i>"u"&&(i=this.statics[e],typeof i<"u"&&(t=!0)),typeof i>"u"&&(i=this.context[e],typeof i<"u"?s=!0:i=this.context[this.symbols.DYNAMIC+e]);let n=!this.scripting.isParseable(i);return{result:i,isStatic:t,isUser:s,resolved:n}}inlineAssignment(e,t,s){let i=this.symbols,n=i.STATIC+e,r=this.restoreTransforms(s,t);return s=i.OPEN_CHOICE+(n+"="+r)+i.CLOSE_CHOICE,s}choiceId(e){if(!e.OC||!e.OC.length)throw Error("invalid choice");return e.OC[0].startOffset+"."+e.OC[0].endOffset}parseOptions(e){let t=[];if(e&&e?.children?.wexpr){let s=e.children.wexpr;for(let i=0;i<s.length;i++){let n=s[i],r=n.children.expr;if(r&&r.length!=1)throw Error("invalid choice-expr: "+r.length);let o=n.children.Weight;if(o){if(o.length!=1)throw Error("invalid weight: "+o.length);let l=1;try{l=parseInt(this.symbols.CLOSE_WEIGHT.length?o[0].image.trim().slice(1,-1):o[0].image.trim().slice(1))}catch{console.log("EX: "+l)}Array.from({length:l},()=>t.push(r))}else t.push(r||"")}}return t}chooseUnique(e,t){for(;e.length;){let{index:i,value:n}=this.choose(e);if(n!==this.choices[t])return n;e.splice(i,1)}throw Error("No remaining options")}choose(e,t=[]){if(!e||!e.length)throw Error("Invalid choice: no options");let s=e.filter(o=>!t.includes(o));if(!s.length)throw Error("Invalid choice: no valid options");let i=this.scripting.RiTa.randi(s.length),n="",r=s[i];return typeof r=="string"?this.print("choice.text","''"):(this.path="choice."+this.path,n=this.visit(r)),typeof n=="string"&&(n=n.trim()),{index:i,value:n}}applyTransforms(e,t){this.traceTx&&console.log("applyTransforms",this.formatTxs(...arguments));for(let s=0;s<t.length;s++)e=this.applyTransform(e,t[s]);return e}restoreTransforms(e,t){return typeof e=="string"&&(new RegExp("^"+this.escaped.OPEN_CHOICE+".*"+this.escaped.CLOSE_CHOICE+"$").test(e)||(e=this.symbols.OPEN_CHOICE+e+this.symbols.CLOSE_CHOICE),t&&t.forEach(i=>e+=i.image),this.traceTx&&console.log("restoreTransforms:",e)),e}castValues(e){let t=!1;return Object.entries(e).forEach(([s,i])=>{let n=parseFloat(i);isNaN(n)||(t=!0,e[s]=n)}),t}contextIsResolved(e){let t=!0;return Object.entries(e).forEach(([s,i])=>{this.scripting.isParseable(i)||(t=!1)}),t}applyTransform(e,t){let s=t.image,i,n=e+s,r=s.substring(1).replace(/\(\)$/,"");return typeof this.dynamics[r]=="function"?i=this.dynamics[r](e):typeof this.statics[r]=="function"?i=this.statics[r](e):typeof this.context[r]=="function"?i=this.context[r](e):typeof this.RiScript.transforms[r]=="function"?i=this.RiScript.transforms[r](e):typeof e[r]=="function"?i=e[r]():e.hasOwnProperty(r)?i=e[r]:(!this.scripting.RiTa.SILENT&&!this.scripting.silent&&console.warn("[WARN] Unresolved transform: "+n),i=n.replace(/\(\)$/,"&lpar;&rpar;")),this.trace&&console.log(`${this.tindent()}[transform] ${n} -> '${i}'`),i}lookupsToString(){let e={},t={};return Object.entries(this.dynamics||{}).forEach(([s,i])=>e[`$${s} `]=i),Object.entries(this.statics||{}).forEach(([s,i])=>t[`#${s} `]=i),JSON.stringify({...this.context,...t,...e},(s,i)=>typeof i=="function"?"<f*:pending>":i).replace(/"/g,"")}formatTxs(e,t){return e+t.map(s=>s.image.replace(/()/,"")+"()").join("")}print(e,...t){this.trace&&(this.path&&e!=="script"&&(e=this.path.replace(/\.$/,"")),console.log(++this.order,`[${e}]`,...t),this.path="")}tindent(){return" ".repeat((this.order+"").length+1)}};var{decode:F}=j,Y=/[aeiou]/,y="_RE_",D=/&([a-z0-9]+|#[0-9]{1,6}|#x[0-9a-fA-F]{1,6});/gi,N=class extends H{constructor(e,t,s){if(typeof t=="string"){let i=t;t=e.parseJSOL(t)}super(t,s)}test(e){for(let t=0,s=this.compiled.length;t<s;t++)if(!this.compiled[t](e))return!1;return!0}operands(){let e=[this.condition],t=new Set;for(;e?.length>0;){let s=e.pop();Object.keys(s).forEach(i=>{let n=s[i];i.startsWith("$")||t.add(i),typeof n=="object"&&n!==null&&(Array.isArray(n)?n:[n]).forEach(o=>e.push(o))})}return Array.from(t)}},u=class{static evaluate(e,t,s={}){return new u().evaluate(e,t,s)}constructor(e={}){this.visitor=0,this.v2Compatible=e.compatibility===2;let{Constants:t,tokens:s}=w(this.v2Compatible);this.Escaped=t.Escaped,this.Symbols=t.Symbols;let i=t.Escaped.STATIC+t.Escaped.DYNAMIC,n=t.Escaped.OPEN_CHOICE,r=t.Escaped.CLOSE_CHOICE;this.JSOLIdentRE=new RegExp(`([${i}]?[A-Za-z_0-9][A-Za-z_0-9]*)\\s*:`,"g"),this.RawAssignRE=new RegExp(`^[${i}][A-Za-z_0-9][A-Za-z_0-9]*\\s*=`),this.ChoiceWrapRE=new RegExp("^"+n+"[^"+n+r+"]*"+r+"$"),this.SpecialRE=new RegExp(`[${this.Escaped.SPECIAL.replace("&","")}]`),this.ContinueRE=new RegExp(this.Escaped.CONTINUATION+"\\r?\\n","g"),this.WhitespaceRE=/[\u00a0\u2000-\u200b\u2028-\u2029\u3000]+/g,this.AnySymbolRE=new RegExp(`[${i}]`),this.silent=!1,this.lexer=new z(s),this.parser=new T(s),this.RiTa=e.RiTa||{VERSION:0,randi:o=>Math.floor(Math.random()*o)}}lex(e){if(!e.input)throw Error("no input");let t=this.lexer.tokenize(e.input);if(t.errors.length)throw console.error("Input: "+e.input+`
`,t.errors[0].message),Error("[LEXING] "+t.errors[0].message);e.trace&&this.printTokens(t.tokens),e.tokens=t.tokens}parse(e){e.cst=this.parser.parse(e)}visit(e){return this.visitor.start(e)}lexParseVisit(e={}){return this.lex(e),this.parse(e),this.visit(e)}evaluate(e,t,s={}){if(typeof e!="string")throw Error("RiScript.evaluate() expects a string, got "+typeof e);return s.input=e,s.visitor=new R(this,t),this._evaluate(s)}_evaluate(e){let{input:t}=e,s,i=/\r?\n$/.test(t),n=this.preParse(t,e);if(!n)return"";if(e.trace&&console.log(`
Input:  '${u._escapeText(t)}'`),e.trace&&t!==n&&console.log(`Parsed: '${u._escapeText(n)}'`),!e.visitor)throw Error("no visitor");this.visitor=e.visitor,delete e.visitor;for(let r=1;n!==s&&r<=10&&(s=n,e.trace&&console.log("-".repeat(20)+" Pass#"+r+" "+"-".repeat(20)),e.input=n,n=this.lexParseVisit(e),e.trace&&console.log(`Result(${r}) -> "${u._escapeText(n)}" ctx=${this.visitor.lookupsToString()}`),!(e.onepass||!this.isParseable(n)));r++);return!this.silent&&!this.RiTa.SILENT&&this.AnySymbolRE.test(n.replace(D,""))&&console.warn('[WARN] Unresolved symbol(s) in "'+n.replace(/\n/g,"\\n")+'" '),this.postParse(n,e)+(i?`
`:"")}_query(e,t){return new N(this,e,t)}printTokens(e){let t=e.reduce((s,i)=>{let{name:n}=i.tokenType,r=n;return r==="TEXT"&&(r=u._escapeText(i.image,1)),r==="SYM"&&(r="sym("+i.image+")"),r==="TX"&&(r="tx("+i.image+")"),s+r+", "},"").slice(0,-2);console.log(`
Tokens: [ `+t+" ]  Context:",this.visitor.lookupsToString())}postParse(e,t){if(typeof e!="string")return"";let i=F(e).replace(this.WhitespaceRE," ").replace(/\r?\n$/,"");return[...i.matchAll(this.Symbols.PENDING_GATE_RE)].forEach(r=>{if(!r||!r[0]||!r[1])throw Error("bad gate: "+r);let o=this.visitor.pendingGates[r[1]],{deferredContext:l,operands:c}=o;if(!c.length)throw Error("no operands");let p=this.visitor.choice(l,{forceReject:!0});i=i.replace(r[0],p),t.trace&&console.log("  "+r[0]+"-> "+p)}),t.trace&&console.log(`
Final: '${i}'`),t.preserveLookups||(this.visitor.statics=void 0,this.visitor.dynamics=void 0),i}preParse(e,t){if(typeof e!="string")return"";let s=this.Symbols,i=e;this.v2Compatible||(i=i.replace(/\((\s*\d+\s*)\)/g,"^$1^")),i=i.replace(/\/\*[^]*?(\r?\n)?\//g,""),i=i.replace(/\/\/[^\n]+(\r?\n|$)/g,""),i=i.replace(this.ContinueRE,""),i=q(i);let n="",r=i.split(/\r?\n/);for(let o=0;o<r.length;o++)if(this.RawAssignRE.test(r[o])){let l=r[o].indexOf("=");if(l<0)throw Error("invalid state: no assigment: "+r[o]);let c=r[o].substring(0,l),p=r[o].substring(l+1),g=C(p,s.OPEN_CHOICE),h=C(p,s.CLOSE_CHOICE);for(;g>h;){let m=r[++o];p+=`
`+m,g+=C(m,s.OPEN_CHOICE),h+=C(m,s.CLOSE_CHOICE)}n+=s.OPEN_SILENT+(c+"="+p)+s.CLOSE_SILENT}else n+=r[o],o<r.length-1&&(n+=`
`);return n}parseJSOL(e){let t=r=>{let o=r;if(typeof r=="string"&&r.startsWith(y)&&r.endsWith(y)){let l=r.split(y);if(l.length!==4)throw Error("invalid regex in unescape");o=new RegExp(l[1],l[2])}return o},s=u._escapeJSONRegex(e).replace(this.JSOLIdentRE,'"$1":').replace(/'/g,'"'),i=JSON.parse(s),n=t;return Object.keys(i).forEach(r=>i[r]=n(i[r])),i}isParseable(e){let t=!0;return/(string|number)/.test(typeof e)&&(t=this.SpecialRE.test(e.toString())),t}static articlize(e){if(!e||!e.length)return"";let t=e.split(/\s+/)[0];if(!u.RiTa?.phones)return u.RiTaWarnings.phones||(console.warn("[WARN] Install RiTa for proper phonemes"),u.RiTaWarnings.phones=!0),(/^[aeiou].*/i.test(t)?"an ":"a ")+e;let s=u.RiTa.phones(t,{silent:!0});return(s&&s.length&&Y.test(s[0])?"an ":"a ")+e}static capitalize(e){return e?e[0].toUpperCase()+e.substring(1):""}static uppercase(e){return e?e.toUpperCase():""}static quotify(e){return"&#8220;"+(e||"")+"&#8221;"}static pluralize(e){return u.RiTa?.pluralize?u.RiTa.pluralize(e):(u.RiTaWarnings.plurals||(u.RiTaWarnings.plurals=!0,console.warn("[WARN] Install RiTa for proper pluralization")),e.endsWith("s")?e:e+"s")}static identity(e){return e}static _transformNames(e){return e&&e.length?e.map(t=>t.image.replace(/(^\.|\(\)$)/g,""),[]):[]}static _escapeText(e,t){if(typeof e!="string")return e;let s=e.replace(/\r?\n/g,"\\n");return t||!s.length?"'"+s+"'":s}static _escapeJSONRegex(e){return e.replace(/\/([^/]+?)\/([igmsuy]*)/g,`"${y}$1${y}$2${y}"`)}static _stringHash(e){let t,s=0;for(let n=0;n<e.length;n++)t=e.charCodeAt(n),s=(s<<5)-s+t,s|=0;let i=s.toString();return s<0?i.replace("-","0"):i}},f=u;O(f,"Query",N),O(f,"VERSION","[VI]{version}[/VI]"),O(f,"RiTaWarnings",{plurals:!1,phones:!1});f.transforms={quotify:f.quotify,pluralize:f.pluralize,capitalize:f.capitalize,articlize:f.articlize,uppercase:f.uppercase,norepeat:f.identity,art:f.articlize,nr:f.identity,cap:f.capitalize,ucf:f.capitalize,uc:f.uppercase,qq:f.quotify,s:f.pluralize};function q(a){return a=d(a,"\\(","&lpar;"),a=d(a,"\\)","&rpar;"),a=d(a,"\\[","&lsqb;"),a=d(a,"\\]","&rsqb;"),a=d(a,"\\{","&lcqb;"),a=d(a,"\\}","&rcqb;"),a=d(a,"\\@","&commat;"),a=d(a,"\\#","&num;"),a=d(a,"\\|"," &vert"),a=d(a,"\\="," &equals"),a}function B(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function d(a,e,t){return a.replace(new RegExp(B(e),"g"),()=>t)}function C(a,e){let t=0;for(let s=0;s<a.length;s++)a[s]===e&&t++;return t}export{f as RiScript};
//# sourceMappingURL=riscript.js.map