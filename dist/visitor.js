var f=class{constructor(t){this.input=0,this.path="",this.tracePath=!0,this.scripting=t,this.warnOnInvalidGates=!1,this.RiScript=this.scripting.constructor}isCstNode(t){return typeof t=="object"&&("accept"in t||"name"in t&&"location"in t&&"children"in t)}visit(t,e){if(Array.isArray(t)&&(t=t[0]),typeof t>"u")return;if(!this.isCstNode(t))throw Error("Non-cstNode passed to visit: "+JSON.stringify(t));let{name:s,location:i}=t;if(this.nodeText=this.input.substring(i.startOffset,i.endOffset+1),typeof this[s]!="function")throw Error(`BaseVisitor.visit: expecting function for this[${s}], found ${typeof this[s]}: ${JSON.stringify(this[s])}`);return this.tracePath&&!/(expr|atom|silent)/.test(s)&&(this.path+=s+"."),this[s](t.children,e)}validateVisitor(){}},u=class extends f{constructor(t,e={}){super(t),this.context=e,this.trace=0,this.choices={},this.isNoRepeat=!1,this.symbols=this.scripting.Symbols,this.escaped=this.scripting.Escaped,this.statics={},this.dynamics={},this.pendingGates={},this.pendingSymbols=new Set,this.validateVisitor()}start(t={}){if(this.input=t.input,this.trace=t.trace,this.traceTx=t.traceTx,!t.cst)throw Error("no cst");return super.visit(t.cst)}script(t){this.order=0;let e=t.expr?t.expr.length:0;if(this.print("script","'"+this.RiScript._escapeText(this.input)+"' :: "+e+" expression(s)"),!e)return"";if(Object.keys(t).length!==1)throw Error("script: invalid expr");return this.visit(t.expr)}expr(t){let e=Object.keys(t);if(e.length!==1)throw Error("invalid expr: "+e.length);let s=t.atom.map(i=>this.visit(i));for(let i=1;i<s.length-1;i++)s[i].length===0&&s[i-1].endsWith(" ")&&s[i+1].startsWith(" ")&&(s[i+1]=s[i+1].substring(1));return s.join("")}wexpr(t){this.print("wexpr")}gate(t){if(t.Gate.length!==1)throw Error("Invalid gate: "+t.Gate);let e,s=t.Gate[0].image;try{e=this.scripting._query(s)}catch(o){if(!this.warnOnInvalidGates)throw Error(`Invalid gate[2]: "@${s}@"

RootCause -> ${o}`);return!this.scripting.RiTa.SILENT&&!this.scripting.silent&&console.warn(`[WARN] Ignoring invalid gate: @${s}@
`,o),{decision:"accept"}}let i={},n=[],r=e.operands();if(r.forEach(o=>{let{result:a,resolved:c,isStatic:p,isUser:l}=this.checkContext(o);typeof a=="function"&&(a=a.call(),c=!this.scripting.isParseable(a)),typeof a>"u"||!c?n.push(o):(p?this.statics[o]=a:l?this.context[o]=a:this.dynamics[o]=a,i[o]=a)}),Object.keys(i).length+n.length!==r.length)throw Error("invalid operands");if(n.length)return{decision:"defer",operands:n};let h=e.test(i);return!h&&this.castValues(i)&&(h=e.test(i)),{decision:h?"accept":"reject"}}assign(t,e){let s=t.SYM[0].image,i,n,r=s.replace(this.scripting.AnySymbolRE,"");if(s.startsWith(this.symbols.STATIC))i=this.visit(t.expr),this.scripting.isParseable(i)?(this.statics[r]=i,i=this.inlineAssignment(r,t.TF,i)):(this.statics[r]=i,this.pendingSymbols.delete(r),this.trace&&console.log("  [pending.delete]",s,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):"")),n=`${s} = ${this.RiScript._escapeText(i)} [#static] ${e?.silent?"{silent}":""}`;else{let o=this;i=()=>o.visit(t.expr),n=`${s} = <f*:pending>`+(e?.silent?"{silent}":""),this.dynamics[r]=i}return this.print("assign",n),i}silent(t){return t.EQ?this.assign(t,{silent:!0}):this.symbol(t,{silent:!0}),""}atom(t){let e,s=Object.keys(t);if(s.length!==1)throw Error("invalid atom: "+s);return this.scripting.parser.atomTypes.forEach(i=>{let n=t[i];if(n){if(n.length!==1)throw Error(i+": bad length -> "+t[i].length);e=this.visit(n[0])}}),typeof e=="function"&&(e=e.call()),e}text(t){if(t.Raw.length!==1)throw Error("[1] invalid text");if(Object.keys(t).length!==1)throw Error("[2] invalid text");let e=t.Raw[0].image;return this.print("text",this.RiScript._escapeText("'"+e+"'")),e}entity(t){return this.nodeText}symbol(t,e){if(t.SYM.length!==1)throw Error("[1] invalid symbol");let s=this.nodeText,i=t.SYM[0].image,n=i.replace(this.scripting.AnySymbolRE,"");if(this.isNoRepeat=this.hasNoRepeat(t.TF),this.pendingSymbols.has(n))return this.print("symbol",`${i} [is-pending]`),s;let{result:r,isStatic:h,isUser:o,resolved:a}=this.checkContext(n);if(!h&&i.startsWith(this.symbols.STATIC)&&!this.scripting.EntityRE.test(i))throw Error(`Attempt to refer to dynamic symbol '${n}' as ${this.symbols.STATIC}${n}, did you mean $${n}?`);if(typeof r=="function"&&(r=r.call(),a=!this.scripting.isParseable(r)),this.isNoRepeat&&(h||o)){this.isNoRepeat=!1;let p="Attempt to call norepeat() on "+(h?"static symbol '"+i+"'. Did you mean to use '"+this.symbols.DYNAMIC+n+"' ?":"non-dynamic symbol '"+n+"'. Did you mean to define '"+this.symbols.DYNAMIC+n+"' in riscript?");throw Error(p)}if(typeof r>"u")return this.print("symbol",i+" -> '"+s+"' ctx="+this.lookupsToString(),"[deferred]",e?.silent?"{silent}":""),s;let c=s+" -> '"+r+"'"+(e?.silent?" {silent}":"");return typeof r=="string"&&!a?(h?(this.pendingSymbols.add(n),r=this.inlineAssignment(n,t.TF,r),this.print("symbol*",`${s} -> ${r} :: pending.add(${n})`)):(t.TF&&(r=this.restoreTransforms(r,t.TF)),this.print("symbol",c)),r):(h&&(this.statics[n]=r),t.TF&&(r=this.applyTransforms(r,t.TF),c+=" -> '"+r+"'",this.isNoRepeat&&(c+=" (norepeat)")),this.print("symbol",c),this.pendingSymbols.has(n)&&(this.trace&&console.log("  [$pending.delete]",(h?"#":"$")+n,this.pendingSymbols.length?JSON.stringify(this.pendingSymbols):""),this.pendingSymbols.delete(n)),this.isNoRepeat=!1,r)}pgate(t){this.print("pgate",this.nodeText);let e=this.nodeText,s=e.replace(this.symbols.PENDING_GATE,""),i=this.pendingGates[s];if(!i)throw Error('no pending gate="'+e+'" pgates='+JSON.stringify(Object.keys(this.pendingGates)));return i.operands.some(h=>{let{result:o,resolved:a}=this.checkContext(h);return typeof o=="function"&&(o=o.call(),a=!this.scripting.isParseable(o)),typeof o>"u"||!a})?e:this.choice(i.deferredContext)}else(t){return this.visit(t.expr).trim()}choice(t,e){let s=this.symbols,i,n,r=this.nodeText,h=r,o=this.RiScript._stringHash(r+" #"+this.choiceId(t));if(!this.isNoRepeat&&this.hasNoRepeat(t.TF))throw Error("noRepeat() not allowed on choice (use a $variable instead): "+r);let a="accept";if(e?.forceReject)a="reject";else if(t.gate&&(i=t.gate[0].children.Gate[0].image,n=this.visit(t.gate),a=n.decision,h+=`
  [gate] ${i} -> ${a!=="defer"?a.toUpperCase():`DEFER ${s.PENDING_GATE}${o}`}  ${this.lookupsToString()}`),n&&n.decision==="defer")return this.pendingGates[o]={deferredContext:t,operands:n.operands},`${s.PENDING_GATE}${o}`;if(a==="reject"&&!("reject"in t))return"";let c=t[a]?.[0]?.children?.or_expr?.[0],p=this.parseOptions(c);if(!p)throw Error("No options in choice: "+r);let l=null,d=[],g=!1;for(;l===null;){if(l=this.choose(p,d).value,this.scripting.isParseable(l)){t.TF&&(l=this.restoreTransforms(l,t.TF)),g=!0;break}if(t.TF&&(l=this.applyTransforms(l,t.TF)),this.isNoRepeat&&l===this.choices[o]){this.print("choice.reject",l+" [norepeat]"),d.push(l),l=null;continue}}return g||(this.choices[o]=l),l}hasNoRepeat(t){let e=this.RiScript._transformNames(t);return e.length?e.includes("nr")||e.includes("norepeat"):!1}checkContext(t){let e=!1,s=!1,i;if(t.length===0)return{result:"",resolved:!0,isStatic:e,isUser:s};i=this.dynamics[t],typeof i>"u"&&(i=this.statics[t],typeof i<"u"&&(e=!0)),typeof i>"u"&&(i=this.context[t],typeof i<"u"?s=!0:i=this.context[this.symbols.DYNAMIC+t]);let n=!this.scripting.isParseable(i);return{result:i,isStatic:e,isUser:s,resolved:n}}inlineAssignment(t,e,s){let i=this.symbols,n=i.STATIC+t,r=this.restoreTransforms(s,e);return s=i.OPEN_CHOICE+(n+"="+r)+i.CLOSE_CHOICE,s}choiceId(t){if(!t.OC||!t.OC.length)throw Error("invalid choice");return t.OC[0].startOffset+"."+t.OC[0].endOffset}parseOptions(t){let e=[];if(t&&t?.children?.wexpr){let s=t.children.wexpr;for(let i=0;i<s.length;i++){let n=s[i],r=n.children.expr;if(r&&r.length!=1)throw Error("invalid choice-expr: "+r.length);let h=n.children.Weight;if(h){if(h.length!=1)throw Error("invalid weight: "+h.length);let o=1;try{o=parseInt(this.symbols.CLOSE_WEIGHT.length?h[0].image.trim().slice(1,-1):h[0].image.trim().slice(1))}catch{console.log("EX: "+o)}Array.from({length:o},()=>e.push(r))}else e.push(r||"")}}return e}chooseUnique(t,e){for(;t.length;){let{index:i,value:n}=this.choose(t);if(n!==this.choices[e])return n;t.splice(i,1)}throw Error("No remaining options")}choose(t,e=[]){if(!t||!t.length)throw Error("Invalid choice: no options");let s=t.filter(h=>!e.includes(h));if(!s.length)throw Error("Invalid choice: no valid options");let i=this.scripting.RiTa.randi(s.length),n="",r=s[i];return typeof r=="string"?this.print("choice.text","''"):(this.path="choice."+this.path,n=this.visit(r)),typeof n=="string"&&(n=n.trim()),{index:i,value:n}}applyTransforms(t,e){this.traceTx&&console.log("applyTransforms",this.formatTxs(...arguments));for(let s=0;s<e.length;s++)t=this.applyTransform(t,e[s]);return t}restoreTransforms(t,e){return typeof t=="string"&&(new RegExp("^"+this.escaped.OPEN_CHOICE+".*"+this.escaped.CLOSE_CHOICE+"$").test(t)||(t=this.symbols.OPEN_CHOICE+t+this.symbols.CLOSE_CHOICE),e&&e.forEach(i=>t+=i.image),this.traceTx&&console.log("restoreTransforms:",t)),t}castValues(t){let e=!1;return Object.entries(t).forEach(([s,i])=>{let n=parseFloat(i);isNaN(n)||(e=!0,t[s]=n)}),e}contextIsResolved(t){let e=!0;return Object.entries(t).forEach(([s,i])=>{this.scripting.isParseable(i)||(e=!1)}),e}applyTransform(t,e){let s=e.image,i,n=t+s,r=s.substring(1).replace(/\(\)$/,"");return typeof this.dynamics[r]=="function"?i=this.dynamics[r](t):typeof this.statics[r]=="function"?i=this.statics[r](t):typeof this.context[r]=="function"?i=this.context[r](t):typeof this.RiScript.transforms[r]=="function"?i=this.RiScript.transforms[r](t):typeof t[r]=="function"?i=t[r]():t.hasOwnProperty(r)?i=t[r]:(!this.scripting.RiTa.SILENT&&!this.scripting.silent&&console.warn("[WARN] Unresolved transform: "+n),i=n.replace(/\(\)$/,"&lpar;&rpar;")),this.trace&&console.log(`${this.tindent()}[transform] ${n} -> '${i}'`),i}lookupsToString(){let t={},e={};return Object.entries(this.dynamics||{}).forEach(([s,i])=>t[`$${s} `]=i),Object.entries(this.statics||{}).forEach(([s,i])=>e[`#${s} `]=i),JSON.stringify({...this.context,...e,...t},(s,i)=>typeof i=="function"?"<f*:pending>":i).replace(/"/g,"")}formatTxs(t,e){return t+e.map(s=>s.image.replace(/()/,"")+"()").join("")}print(t,...e){this.trace&&(this.path&&t!=="script"&&(t=this.path.replace(/\.$/,"")),console.log(++this.order,`[${t}]`,...e),this.path="")}tindent(){return" ".repeat((this.order+"").length+1)}};export{u as RiScriptVisitor};
